{% extends "base.html" %}

{% block title %}API Configuration - TPRM Tool{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8" x-data="apiConfigApp()">
    <!-- Header -->
    <header class="mb-8">
        <div>
            <h1 class="text-3xl font-bold text-white">API Configuration</h1>
            <p class="text-gray-400 mt-2">Configure external API keys for real-time data access</p>
        </div>
    </header>

    <!-- Current Status -->
    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 mb-8">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold text-white">Current Configuration Status</h2>
            <div class="flex items-center space-x-2">
                <div class="w-3 h-3 rounded-full" :class="allConfigured ? 'bg-green-400' : 'bg-yellow-400'"></div>
                <span class="text-sm" :class="allConfigured ? 'text-green-400' : 'text-yellow-400'" 
                      x-text="allConfigured ? 'Fully Configured' : 'Demo Mode'"></span>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-gray-700/30 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-medium text-white">OpenAI API</h3>
                    <div class="w-3 h-3 rounded-full" :class="config.openai ? 'bg-green-400' : 'bg-red-400'"></div>
                </div>
                <p class="text-xs text-gray-400">AI-powered analysis</p>
                <p class="text-sm mt-2" :class="config.openai ? 'text-green-400' : 'text-red-400'" 
                   x-text="config.openai ? 'Configured' : 'Missing'"></p>
            </div>
            
            <div class="bg-gray-700/30 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-medium text-white">DART Registry</h3>
                    <div class="w-3 h-3 rounded-full" :class="config.dart ? 'bg-green-400' : 'bg-red-400'"></div>
                </div>
                <p class="text-xs text-gray-400">Korean company data</p>
                <p class="text-sm mt-2" :class="config.dart ? 'text-green-400' : 'text-red-400'" 
                   x-text="config.dart ? 'Configured' : 'Missing'"></p>
            </div>
            
            <div class="bg-gray-700/30 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-medium text-white">Google Search</h3>
                    <div class="w-3 h-3 rounded-full" :class="config.google ? 'bg-green-400' : 'bg-red-400'"></div>
                </div>
                <p class="text-xs text-gray-400">Real-time web search</p>
                <p class="text-sm mt-2" :class="config.google ? 'text-green-400' : 'text-red-400'" 
                   x-text="config.google ? 'Configured' : 'Missing'"></p>
            </div>
            
            <div class="bg-gray-700/30 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-medium text-white">Dilisense</h3>
                    <div class="w-3 h-3 rounded-full bg-gray-400"></div>
                </div>
                <p class="text-xs text-gray-400">Sanctions & PEP screening</p>
                <p class="text-sm mt-2 text-gray-400">Enterprise only</p>
            </div>
        </div>
    </div>

    <!-- Configuration Guide -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- API Keys Setup -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <h3 class="text-xl font-semibold text-white mb-6">Environment Variables</h3>
            <div class="space-y-4">
                <div class="bg-gray-900 rounded-lg p-4 font-mono text-sm">
                    <div class="text-green-400 mb-2"># Required API Keys</div>
                    <div class="space-y-1 text-gray-300">
                        <div>OPENAI_API_KEY=sk-your-key-here</div>
                        <div>DART_API_KEY=your-dart-key-here</div>
                        <div>GOOGLE_API_KEY=your-google-key-here</div>
                        <div>GOOGLE_CSE_ID=your-cse-id-here</div>
                        <div class="text-gray-500"># Optional</div>
                        <div>DILISENSE_API_KEY=your-dilisense-key</div>
                        <div>SERPER_API_KEY=your-serper-key</div>
                    </div>
                </div>
                
                <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                    <div class="flex items-start space-x-3">
                        <svg class="w-5 h-5 text-blue-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <p class="text-blue-200 font-medium">Development Mode</p>
                            <p class="text-blue-300 text-sm mt-1">Create a <code>.env</code> file in the project root with your API keys</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                    <div class="flex items-start space-x-3">
                        <svg class="w-5 h-5 text-green-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <p class="text-green-200 font-medium">Production Mode</p>
                            <p class="text-green-300 text-sm mt-1">Set environment variables in your hosting platform (Render, Heroku, etc.)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Providers Info -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <h3 class="text-xl font-semibold text-white mb-6">API Provider Information</h3>
            <div class="space-y-4">
                <div class="border-l-4 border-blue-500 pl-4">
                    <h4 class="font-medium text-blue-400">OpenAI GPT-4</h4>
                    <p class="text-gray-300 text-sm mt-1">Powers intelligent data extraction and risk analysis from web sources</p>
                    <a href="https://platform.openai.com/" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm">Get API Key →</a>
                </div>
                
                <div class="border-l-4 border-green-500 pl-4">
                    <h4 class="font-medium text-green-400">DART Registry</h4>
                    <p class="text-gray-300 text-sm mt-1">Official Korean Financial Supervisory Service company registry</p>
                    <a href="https://opendart.fss.or.kr/" target="_blank" class="text-green-400 hover:text-green-300 text-sm">Register for Free →</a>
                </div>
                
                <div class="border-l-4 border-purple-500 pl-4">
                    <h4 class="font-medium text-purple-400">Google Custom Search</h4>
                    <p class="text-gray-300 text-sm mt-1">Real-time web search for comprehensive company intelligence</p>
                    <a href="https://developers.google.com/custom-search/" target="_blank" class="text-purple-400 hover:text-purple-300 text-sm">Setup Guide →</a>
                </div>
                
                <div class="border-l-4 border-yellow-500 pl-4">
                    <h4 class="font-medium text-yellow-400">Dilisense</h4>
                    <p class="text-gray-300 text-sm mt-1">Professional sanctions, PEP, and compliance screening</p>
                    <a href="https://dilisense.com/" target="_blank" class="text-yellow-400 hover:text-yellow-300 text-sm">Contact Sales →</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Demo vs Real Data Comparison -->
    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 mb-8">
        <h3 class="text-xl font-semibold text-white mb-6">Demo vs Real Data Comparison</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-700">
                <thead>
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Feature</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Demo Mode</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Real APIs</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-700">
                    <tr>
                        <td class="px-6 py-4 text-sm font-medium text-white">Company Information</td>
                        <td class="px-6 py-4 text-sm text-yellow-400">Sample companies with realistic data</td>
                        <td class="px-6 py-4 text-sm text-green-400">Live web scraping & AI analysis</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-4 text-sm font-medium text-white">Executive Data</td>
                        <td class="px-6 py-4 text-sm text-yellow-400">Sample executive profiles</td>
                        <td class="px-6 py-4 text-sm text-green-400">Real-time leadership information</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-4 text-sm font-medium text-white">Adverse Media</td>
                        <td class="px-6 py-4 text-sm text-yellow-400">Simulated news incidents</td>
                        <td class="px-6 py-4 text-sm text-green-400">Live news monitoring & analysis</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-4 text-sm font-medium text-white">DART Registry</td>
                        <td class="px-6 py-4 text-sm text-yellow-400">Sample Korean companies</td>
                        <td class="px-6 py-4 text-sm text-green-400">Official FSS registry data</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-4 text-sm font-medium text-white">PEP Screening</td>
                        <td class="px-6 py-4 text-sm text-yellow-400">Sample PEP profiles</td>
                        <td class="px-6 py-4 text-sm text-green-400">Live sanctions & PEP databases</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-4 text-sm font-medium text-white">Response Time</td>
                        <td class="px-6 py-4 text-sm text-yellow-400">⚡ Instant (cached)</td>
                        <td class="px-6 py-4 text-sm text-green-400">🕐 2-5 seconds (real-time)</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Quick Test -->
    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
        <h3 class="text-xl font-semibold text-white mb-6">Test API Configuration</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <button @click="testCompanyAPI()" :disabled="testing" 
                    class="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 rounded-lg p-4 text-left transition-colors">
                <div class="flex items-center space-x-3">
                    <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                    <div>
                        <p class="text-white font-medium">Test Company API</p>
                        <p class="text-blue-200 text-sm">Screen a sample company</p>
                    </div>
                </div>
            </button>
            
            <button @click="testIndividualAPI()" :disabled="testing"
                    class="bg-purple-600 hover:bg-purple-700 disabled:opacity-50 rounded-lg p-4 text-left transition-colors">
                <div class="flex items-center space-x-3">
                    <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <div>
                        <p class="text-white font-medium">Test Individual API</p>
                        <p class="text-purple-200 text-sm">Screen a sample person</p>
                    </div>
                </div>
            </button>
            
            <button @click="testDartAPI()" :disabled="testing"
                    class="bg-green-600 hover:bg-green-700 disabled:opacity-50 rounded-lg p-4 text-left transition-colors">
                <div class="flex items-center space-x-3">
                    <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <div>
                        <p class="text-white font-medium">Test DART API</p>
                        <p class="text-green-200 text-sm">Search Korean registry</p>
                    </div>
                </div>
            </button>
        </div>
        
        <!-- Test Results -->
        <div x-show="testResults.length > 0" class="mt-6 space-y-3">
            <h4 class="text-lg font-medium text-white">Test Results</h4>
            <template x-for="result in testResults" :key="result.id">
                <div class="bg-gray-700/30 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white font-medium" x-text="result.test"></p>
                            <p class="text-gray-400 text-sm" x-text="result.message"></p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 rounded-full" :class="result.success ? 'bg-green-400' : 'bg-red-400'"></div>
                            <span class="text-sm" :class="result.success ? 'text-green-400' : 'text-red-400'" 
                                  x-text="result.success ? 'Success' : 'Failed'"></span>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function apiConfigApp() {
    return {
        config: {
            openai: false,
            dart: false,
            google: false,
            dilisense: false
        },
        testing: false,
        testResults: [],
        
        get allConfigured() {
            return this.config.openai && this.config.dart && this.config.google;
        },
        
        init() {
            this.loadConfig();
        },
        
        async loadConfig() {
            try {
                const response = await fetch('/debug/providers');
                if (response.ok) {
                    const data = await response.json();
                    this.config.openai = data.OPENAI || false;
                    this.config.dart = data.DART_API_KEY || false;
                    this.config.google = (data.GOOGLE_API && data.GOOGLE_CSE_ID) || false;
                }
            } catch (e) {
                console.log('Could not load configuration status');
            }
        },
        
        async testCompanyAPI() {
            this.testing = true;
            try {
                const response = await fetch('/api/screen', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ company: 'Samsung Electronics', country: 'South Korea' })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.testResults.unshift({
                        id: Date.now(),
                        test: 'Company Screening API',
                        success: true,
                        message: `${data.company_name} screened successfully. Risk: ${data.overall_risk_level}. ${data._demo_mode ? 'Demo data used.' : 'Real API data used.'}`
                    });
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (e) {
                this.testResults.unshift({
                    id: Date.now(),
                    test: 'Company Screening API',
                    success: false,
                    message: `Test failed: ${e.message}`
                });
            } finally {
                this.testing = false;
            }
        },
        
        async testIndividualAPI() {
            this.testing = true;
            try {
                const response = await fetch('/api/screen_individual', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: 'Maria Rodriguez', country: 'Spain' })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.testResults.unshift({
                        id: Date.now(),
                        test: 'Individual Screening API',
                        success: true,
                        message: `${data.name} screened successfully. PEP: ${data.pep_status ? 'Yes' : 'No'}. ${data._demo_mode ? 'Demo data used.' : 'Real API data used.'}`
                    });
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (e) {
                this.testResults.unshift({
                    id: Date.now(),
                    test: 'Individual Screening API',
                    success: false,
                    message: `Test failed: ${e.message}`
                });
            } finally {
                this.testing = false;
            }
        },
        
        async testDartAPI() {
            this.testing = true;
            try {
                const response = await fetch('/api/dart/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ company: 'Samsung' })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.testResults.unshift({
                        id: Date.now(),
                        test: 'DART Search API',
                        success: true,
                        message: `Found ${data.total_results} companies. ${data._demo_mode ? 'Demo data used.' : 'Real DART API used.'}`
                    });
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (e) {
                this.testResults.unshift({
                    id: Date.now(),
                    test: 'DART Search API',
                    success: false,
                    message: `Test failed: ${e.message}`
                });
            } finally {
                this.testing = false;
            }
        }
    };
}
</script>
{% endblock %}