{% extends "_base.html" %}
{% block page_title %}SEC EDGAR{% endblock %}
{% block page_description %}Pull submissions and latest DEF 14A index{% endblock %}
{% block content %}
<div x-data="sec()" class="space-y-6">
  <div class="metric-card">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="md:col-span-2">
        <label class="text-sm text-gray-500">Company name or ticker</label>
        <input x-model="query" class="input-field" placeholder="Apple or AAPL" />
      </div>
      <div>
        <label class="text-sm text-gray-500">CIK (10 digits)</label>
        <input x-model="cik" class="input-field" placeholder="0000320193" />
      </div>
      <div class="flex items-end">
        <button @click="run()" class="btn-primary w-full">Fetch</button>
      </div>
    </div>
    <div class="mt-3 text-xs text-gray-500">Set SEC_USER_AGENT (e.g., "Risklytics/1.0 (you@example.com)").</div>
  </div>

  <template x-if="error">
    <div class="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-200 p-4 rounded-lg" x-text="error"></div>
  </template>

  <template x-if="mode==='search'">
    <div class="metric-card">
      <h3 class="font-semibold mb-3">Matches</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <template x-for="it in items" :key="it.cik">
          <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
            <div class="font-medium" x-text="it.title"></div>
            <div class="text-xs text-gray-500">Ticker: <span x-text="it.ticker"></span> Â· CIK: <span x-text="it.cik"></span></div>
            <button class="btn-secondary mt-3" @click="cik=it.cik; run()">Open</button>
          </div>
        </template>
      </div>
    </div>
  </template>

  <template x-if="mode==='detail'">
    <div class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="metric-card">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">Key Executives</h3>
            <span class="text-xs text-gray-500" x-text="(quick?.executives||[]).length + ' found'"></span>
          </div>
          <div class="space-y-2">
            <template x-for="e in (quick?.executives||[])" :key="e.name">
              <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3">
                <div class="font-medium" x-text="e.name"></div>
                <div class="text-xs text-gray-500" x-text="e.title"></div>
              </div>
            </template>
            <template x-if="!(quick?.executives||[]).length">
              <div class="text-xs text-gray-500">No executives parsed from proxy.</div>
            </template>
          </div>
        </div>

        <div class="metric-card">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">Major Shareholders</h3>
            <span class="text-xs text-gray-500" x-text="(quick?.holders||[]).length + ' found'"></span>
          </div>
          <div class="space-y-2">
            <template x-for="h in (quick?.holders||[])" :key="h.name">
              <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3">
                <div class="font-medium" x-text="h.name"></div>
                <div class="text-xs text-gray-500" x-text="h.ownership"></div>
              </div>
            </template>
            <template x-if="!(quick?.holders||[]).length">
              <div class="text-xs text-gray-500">No major holders parsed from proxy.</div>
            </template>
          </div>
        </div>
      </div>
    </div>
  </template>
</div>

<script>
function sec() {
  return {
    query: '',
    cik: '',
    error: '',
    json: '',
    mode: '',
    items: [],
    latest: null,
    showRaw: false,
    index: null,
    quick: { executives: [], holders: [] },
    archiveUrl(cik, accession, filename) {
      const cikInt = String(parseInt(cik, 10));
      return `https://www.sec.gov/Archives/edgar/data/${cikInt}/${accession}/${filename}`;
    },
    async run() {
      this.error = '';
      this.json = '';
      this.mode = '';
      this.items = [];
      this.latest = null;
      this.index = null;
      try {
        const body = {};
        if (this.cik.trim()) body.cik = this.cik.trim();
        if (this.query.trim()) body.query = this.query.trim();
        const res = await fetch('/api/sec/company', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok || data.error) throw new Error(data.error || 'Request failed');
        this.json = JSON.stringify(data, null, 2);
        if (data.mode === 'search') {
          this.mode = 'search';
          this.items = data.items || [];
        } else {
          this.mode = 'detail';
          this.latest = data.latest_def14a || null;
          this.index = data.filing_index || null;
          this.quick = data.quick_extract || { executives: [], holders: [] };
        }
      } catch (e) {
        this.error = e.message;
      }
    }
  }
}
</script>
{% endblock %}
