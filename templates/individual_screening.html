{% extends "intelligence_base.html" %}

{% block content %}
<div x-data="individualScreening()" class="space-y-6">
    <!-- Page Header -->
    <div class="glass-panel p-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold tracking-wide text-white/90">Individual Screening</h1>
                <p class="text-white/60 mt-1">Comprehensive risk assessment for individuals (PEP, sanctions, adverse media)</p>
            </div>
            <div class="flex items-center space-x-3">
                <button class="px-4 py-2 bg-accent-blue/20 text-accent-blue rounded-lg hover:bg-accent-blue/30 transition-colors">
                    <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                    Export
                </button>
                <button class="px-4 py-2 bg-accent-mint/20 text-accent-mint rounded-lg hover:bg-accent-mint/30 transition-colors">
                    <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i>
                    New Case
                </button>
            </div>
        </div>
    </div>

    <!-- Screening Form -->
    <div class="glass-panel p-6" x-show="!hasResults">
        <h2 class="text-lg font-semibold mb-4">Screening Parameters</h2>
        
        <form @submit.prevent="startScreening" class="space-y-6">
            <!-- Basic Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-white/80 mb-2">Full Name *</label>
                    <input type="text" x-model="form.fullName" required
                           class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-accent-blue/50"
                           placeholder="Enter full name">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-white/80 mb-2">Date of Birth</label>
                    <input type="date" x-model="form.dateOfBirth"
                           class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-accent-blue/50">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-white/80 mb-2">Countries</label>
                    <select x-model="form.countries" multiple
                            class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-accent-blue/50">
                        <option value="SA">Saudi Arabia</option>
                        <option value="US">United States</option>
                        <option value="EU">European Union</option>
                        <option value="UN">United Nations</option>
                        <option value="UK">United Kingdom</option>
                        <option value="CA">Canada</option>
                        <option value="AU">Australia</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-white/80 mb-2">Nationality</label>
                    <input type="text" x-model="form.nationality"
                           class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-accent-blue/50"
                           placeholder="e.g., Saudi">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-white/80 mb-2">ID Type</label>
                    <select x-model="form.idType"
                            class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-accent-blue/50">
                        <option value="">Select ID Type</option>
                        <option value="passport">Passport</option>
                        <option value="national_id">National ID</option>
                        <option value="drivers_license">Driver's License</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-white/80 mb-2">ID Number</label>
                    <input type="text" x-model="form.idNumber"
                           class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-accent-blue/50"
                           placeholder="ID number if available">
                </div>
            </div>
            
            <!-- Screening Scopes -->
            <div>
                <label class="block text-sm font-medium text-white/80 mb-3">Screening Scopes</label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" x-model="form.scopes" value="sanctions" checked
                               class="rounded accent-accent-blue">
                        <span class="text-sm">Sanctions</span>
                    </label>
                    
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" x-model="form.scopes" value="pep" checked
                               class="rounded accent-accent-blue">
                        <span class="text-sm">PEP (Politically Exposed Persons)</span>
                    </label>
                    
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" x-model="form.scopes" value="adverse_media" checked
                               class="rounded accent-accent-blue">
                        <span class="text-sm">Adverse Media</span>
                    </label>
                </div>
            </div>
            
            <!-- Advanced Controls -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-white/80 mb-2">Fuzzy Threshold</label>
                    <div class="flex items-center space-x-3">
                        <input type="range" x-model="form.fuzzyThreshold" min="0.6" max="0.95" step="0.05"
                               class="flex-1 accent-accent-blue">
                        <span class="text-sm text-white/60 w-12" x-text="form.fuzzyThreshold"></span>
                    </div>
                    <p class="text-xs text-white/50 mt-1">Lower = stricter matching (default: 0.8)</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-white/80 mb-2">Background Job</label>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" x-model="form.backgroundJob" id="backgroundJob"
                               class="rounded accent-accent-blue">
                        <label for="backgroundJob" class="text-sm text-white/60">Queue for processing</label>
                    </div>
                </div>
            </div>
            
            <!-- Notes -->
            <div>
                <label class="block text-sm font-medium text-white/80 mb-2">Notes</label>
                <textarea x-model="form.notes" rows="3"
                          class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-accent-blue/50"
                          placeholder="Additional context or specific concerns..."></textarea>
            </div>
            
            <!-- Submit Button -->
            <div class="flex justify-end">
                <button type="submit" 
                        class="px-6 py-3 bg-accent-blue text-white rounded-lg hover:bg-accent-blue/80 transition-colors font-medium"
                        :disabled="isScreening">
                    <span x-show="!isScreening">Start Screening</span>
                    <span x-show="isScreening" class="flex items-center">
                        <i data-lucide="loader-2" class="w-4 h-4 animate-spin mr-2"></i>
                        Screening...
                    </span>
                </button>
            </div>
        </form>
    </div>

    <!-- Progress Stepper -->
    <div class="glass-panel p-6" x-show="isScreening">
        <h3 class="text-lg font-semibold mb-4">Screening Progress</h3>
        
        <div class="space-y-4">
            <template x-for="(step, index) in progressSteps" :key="index">
                <div class="flex items-center space-x-4">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium"
                             :class="{
                                 'bg-white/20 text-white/60': step.status === 'todo',
                                 'bg-accent-blue text-white': step.status === 'doing',
                                 'bg-accent-mint text-white': step.status === 'done',
                                 'bg-red-500 text-white': step.status === 'fail'
                             }">
                            <span x-show="step.status === 'todo'" x-text="index + 1"></span>
                            <i x-show="step.status === 'doing'" data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                            <i x-show="step.status === 'done'" data-lucide="check" class="w-4 h-4"></i>
                            <i x-show="step.status === 'fail'" data-lucide="x" class="w-4 h-4"></i>
                        </div>
                    </div>
                    
                    <div class="flex-1">
                        <div class="flex items-center justify-between">
                            <span class="font-medium" x-text="step.name"></span>
                            <span class="text-sm text-white/60" x-text="step.timestamp || ''"></span>
                        </div>
                        <div x-show="step.logs && step.logs.length > 0" class="mt-2 text-sm text-white/60">
                            <div x-show="step.logs.length > 0" class="cursor-pointer" @click="step.expanded = !step.expanded">
                                <span x-text="step.expanded ? 'Hide logs' : 'Show logs'"></span>
                                <i data-lucide="chevron-down" class="w-4 h-4 inline ml-1" :class="{'rotate-180': step.expanded}"></i>
                            </div>
                            <div x-show="step.expanded" class="mt-2 space-y-1">
                                <template x-for="log in step.logs" :key="log.id">
                                    <div class="text-xs bg-white/5 p-2 rounded" x-text="log.message"></div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Results Display -->
    <div x-show="hasResults" class="space-y-6">
        <!-- Subject Summary -->
        <div class="glass-panel p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Subject Summary</h3>
                <div class="flex items-center space-x-3">
                    <button class="px-3 py-1 bg-white/10 text-white/80 rounded text-sm hover:bg-white/20 transition-colors">
                        <i data-lucide="edit" class="w-4 h-4 inline mr-1"></i>
                        Edit
                    </button>
                    <button class="px-3 py-1 bg-accent-blue/20 text-accent-blue rounded text-sm hover:bg-accent-blue/30 transition-colors">
                        <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-1"></i>
                        Refresh
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <h4 class="text-sm font-medium text-white/60 mb-2">Individual</h4>
                    <p class="text-lg font-semibold" x-text="results.fullName"></p>
                    <p class="text-sm text-white/60" x-text="results.dateOfBirth || 'DOB not provided'"></p>
                </div>
                
                <div>
                    <h4 class="text-sm font-medium text-white/60 mb-2">Risk Assessment</h4>
                    <div class="flex items-center space-x-3">
                        <div class="px-3 py-1 rounded-full text-sm font-medium" :class="getRiskClass(results.riskScore)">
                            <span x-text="getRiskLevel(results.riskScore)"></span>
                        </div>
                        <span class="text-2xl font-bold" x-text="results.riskScore"></span>
                    </div>
                </div>
                
                <div>
                    <h4 class="text-sm font-medium text-white/60 mb-2">Provenance</h4>
                    <div class="flex flex-wrap gap-2">
                        <template x-for="source in results.dataSources" :key="source">
                            <span class="px-2 py-1 bg-white/10 text-white/80 rounded text-xs" x-text="source"></span>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Tabs -->
        <div class="glass-panel">
            <div class="border-b border-white/10">
                <nav class="flex space-x-8 px-6">
                    <button class="py-4 px-1 border-b-2 font-medium text-sm transition-colors"
                            :class="activeTab === 'overview' ? 'border-accent-blue text-accent-blue' : 'border-transparent text-white/60 hover:text-white/80'"
                            @click="activeTab = 'overview'">
                        Overview
                    </button>
                    <button class="py-4 px-1 border-b-2 font-medium text-sm transition-colors"
                            :class="activeTab === 'results' ? 'border-accent-blue text-accent-blue' : 'border-transparent text-white/60 hover:text-white/80'"
                            @click="activeTab = 'results'">
                        Complete Results
                    </button>
                </nav>
            </div>
            
            <div class="p-6">
                <!-- Overview Tab -->
                <div x-show="activeTab === 'overview'">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Hit Clustering -->
                        <div class="glass-panel p-4 hover-glow cursor-pointer">
                            <h4 class="font-medium mb-3">Hit Clustering</h4>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-white/60">Sanctions</span>
                                    <span class="text-lg font-semibold" x-text="results.dilisenseData?.sanctions?.total_hits || 0"></span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-white/60">PEP</span>
                                    <span class="text-lg font-semibold" x-text="results.dilisenseData?.pep?.total_hits || 0"></span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-white/60">Criminal</span>
                                    <span class="text-lg font-semibold" x-text="results.dilisenseData?.criminal?.total_hits || 0"></span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-white/60">Other</span>
                                    <span class="text-lg font-semibold" x-text="results.dilisenseData?.other?.total_hits || 0"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Risk Summary -->
                        <div class="glass-panel p-4 hover-glow cursor-pointer">
                            <h4 class="font-medium mb-3">Risk Summary</h4>
                            <div class="space-y-2">
                                <div class="text-sm text-white/60">Overall Risk Level</div>
                                <div class="text-lg font-semibold text-accent-blue" x-text="results.dilisenseData?.overall_risk_level || 'Unknown'"></div>
                                <div class="text-xs text-white/40">Based on Dilisense assessment</div>
                            </div>
                        </div>
                        
                        <!-- Data Sources -->
                        <div class="glass-panel p-4 hover-glow cursor-pointer">
                            <h4 class="font-medium mb-3">Data Sources</h4>
                            <div class="space-y-2">
                                <div class="text-sm text-white/60">Total Hits</div>
                                <div class="text-lg font-semibold" x-text="results.dilisenseData?.total_hits || 0"></div>
                                <div class="text-xs text-white/40">From Dilisense API</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Complete Dilisense Results Summary -->
                    <div class="mt-6">
                        <h4 class="font-medium mb-4">Complete Screening Results</h4>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Dilisense Summary -->
                            <div class="glass-panel p-4">
                                <h5 class="font-medium mb-3 text-accent-blue">Dilisense Results</h5>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-white/60">Total Hits:</span>
                                        <span class="font-semibold" x-text="results.dilisenseData?.total_hits || 0"></span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-white/60">Risk Level:</span>
                                        <span class="font-semibold" x-text="results.dilisenseData?.overall_risk_level || 'Unknown'"></span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-white/60">Risk Factors:</span>
                                        <span class="font-semibold" x-text="(results.dilisenseData?.risk_factors || []).join(', ') || 'None'"></span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Data Sources -->
                            <div class="glass-panel p-4">
                                <h5 class="font-medium mb-3 text-accent-mint">Data Sources</h5>
                                <div class="space-y-2">
                                    <template x-for="source in results.dataSources" :key="source">
                                        <div class="flex items-center space-x-2">
                                            <i data-lucide="check-circle" class="w-4 h-4 text-accent-mint"></i>
                                            <span class="text-sm" x-text="source"></span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Complete Results Tab - Raw Dilisense Data -->
                <div x-show="activeTab === 'results'">
                    <div class="space-y-6">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold">Complete Dilisense Results</h3>
                            <button @click="downloadResults()" class="px-3 py-2 bg-accent-blue/20 text-accent-blue rounded text-sm hover:bg-accent-blue/30 transition-colors">
                                <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                                Download JSON
                            </button>
                        </div>
                        
                        <!-- Raw Dilisense Data Display -->
                        <div class="glass-panel p-6">
                            <h4 class="font-medium mb-4 text-accent-blue">Raw Dilisense Response</h4>
                            
                            <!-- Sanctions Section -->
                            <div class="mb-6">
                                <h5 class="font-medium mb-3 text-red-400">Sanctions Records (<span x-text="results.dilisenseData?.sanctions?.total_hits || 0"></span>)</h5>
                                <div x-show="results.dilisenseData?.sanctions?.total_hits > 0" class="space-y-4">
                                    <template x-for="(hit, index) in results.dilisenseData.sanctions.found_records" :key="index">
                                        <div class="bg-red-500/10 border border-red-500/20 rounded-lg p-4">
                                            <pre class="text-sm text-white/80 whitespace-pre-wrap" x-text="JSON.stringify(hit, null, 2)"></pre>
                                        </div>
                                    </template>
                                </div>
                                <div x-show="!results.dilisenseData?.sanctions?.total_hits || results.dilisenseData.sanctions.total_hits === 0" class="text-center py-8 text-white/40">
                                    No sanctions records found
                                </div>
                            </div>
                            
                            <!-- PEP Section -->
                            <div class="mb-6">
                                <h5 class="font-medium mb-3 text-accent-blue">PEP Records (<span x-text="results.dilisenseData?.pep?.total_hits || 0"></span>)</h5>
                                <div x-show="results.dilisenseData?.pep?.total_hits > 0" class="space-y-4">
                                    <template x-for="(hit, index) in results.dilisenseData.pep.found_records" :key="index">
                                        <div class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-4">
                                            <pre class="text-sm text-white/80 whitespace-pre-wrap" x-text="JSON.stringify(hit, null, 2)"></pre>
                                        </div>
                                    </template>
                                </div>
                                <div x-show="!results.dilisenseData?.pep?.total_hits || results.dilisenseData.pep.total_hits === 0" class="text-center py-8 text-white/40">
                                    No PEP records found
                                </div>
                            </div>
                            
                            <!-- Criminal Section -->
                            <div class="mb-6">
                                <h5 class="font-medium mb-3 text-orange-400">Criminal Records (<span x-text="results.dilisenseData?.criminal?.total_hits || 0"></span>)</h5>
                                <div x-show="results.dilisenseData?.criminal?.total_hits > 0" class="space-y-4">
                                    <template x-for="(hit, index) in results.dilisenseData.criminal.found_records" :key="index">
                                        <div class="bg-orange-500/10 border border-orange-500/20 rounded-lg p-4">
                                            <pre class="text-sm text-white/80 whitespace-pre-wrap" x-text="JSON.stringify(hit, null, 2)"></pre>
                                        </div>
                                    </template>
                                </div>
                                <div x-show="!results.dilisenseData?.criminal?.total_hits || results.dilisenseData.criminal.total_hits === 0" class="text-center py-8 text-white/40">
                                    No criminal records found
                                </div>
                            </div>
                            
                            <!-- Other Section -->
                            <div class="mb-6">
                                <h5 class="font-medium mb-3 text-white/60">Other Records (<span x-text="results.dilisenseData?.other?.total_hits || 0"></span>)</h5>
                                <div x-show="results.dilisenseData?.other?.total_hits > 0" class="space-y-4">
                                    <template x-for="(hit, index) in results.dilisenseData.other.found_records" :key="index">
                                        <div class="bg-white/10 border border-white/20 rounded-lg p-4">
                                            <pre class="text-sm text-white/80 whitespace-pre-wrap" x-text="JSON.stringify(hit, null, 2)"></pre>
                                        </div>
                                    </template>
                                </div>
                                <div x-show="!results.dilisenseData?.other?.total_hits || results.dilisenseData.other.total_hits === 0" class="text-center py-8 text-white/40">
                                    No other records found
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Evidence Drawer -->
    <div x-show="selectedHit" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-end">
        <div class="w-96 h-full glass-panel overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Evidence Details</h3>
                    <button @click="selectedHit = null" class="text-white/60 hover:text-white">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <div x-show="selectedHit" class="space-y-4">
                    <div>
                        <h4 class="font-medium mb-2" x-text="selectedHit.name || selectedHit.headline"></h4>
                        <div class="text-sm text-white/60 space-y-2">
                            <div x-show="selectedHit.dataset">
                                <strong>Dataset:</strong> <span x-text="selectedHit.dataset"></span>
                            </div>
                            <div x-show="selectedHit.matchScore">
                                <strong>Match Score:</strong> <span x-text="selectedHit.matchScore + '%'"></span>
                            </div>
                            <div x-show="selectedHit.source">
                                <strong>Source:</strong> <span x-text="selectedHit.source"></span>
                            </div>
                            <div x-show="selectedHit.date">
                                <strong>Date:</strong> <span x-text="selectedHit.date"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pt-4 border-t border-white/10">
                        <div class="flex space-x-2">
                            <button class="px-3 py-2 bg-accent-blue/20 text-accent-blue rounded text-sm hover:bg-accent-blue/30 transition-colors">
                                Assign to Case
                            </button>
                            <button class="px-3 py-2 bg-white/10 text-white/80 rounded text-sm hover:bg-white/20 transition-colors">
                                Copy Record
                            </button>
                            <button class="px-3 py-2 bg-white/10 text-white/80 rounded text-sm hover:bg-white/20 transition-colors">
                                Export PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function individualScreening() {
    return {
        form: {
            fullName: '',
            dateOfBirth: '',
            countries: [],
            nationality: '',
            idType: '',
            idNumber: '',
            scopes: ['sanctions', 'pep', 'adverse_media'],
            fuzzyThreshold: 0.8,
            backgroundJob: false,
            notes: ''
        },
        isScreening: false,
        hasResults: false,
        activeTab: 'overview',
        selectedHit: null,
        progressSteps: [
            { name: 'Query Expansion', status: 'todo', timestamp: '', logs: [], expanded: false },
            { name: 'Web / DB Search', status: 'todo', timestamp: '', logs: [], expanded: false },
            { name: 'Content Extraction', status: 'todo', timestamp: '', logs: [], expanded: false },
            { name: 'Sanctions Check', status: 'todo', timestamp: '', logs: [], expanded: false },
            { name: 'Entity Resolution', status: 'todo', timestamp: '', logs: [], expanded: false },
            { name: 'AI Analysis', status: 'todo', timestamp: '', logs: [], expanded: false },
            { name: 'Report Generation', status: 'todo', timestamp: '', logs: [], expanded: false }
        ],
        results: {},
        
        init() {
            // Check if name was passed via URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const name = urlParams.get('name');
            if (name) {
                this.form.fullName = decodeURIComponent(name);
            }
        },
        
        async startScreening() {
            this.isScreening = true;
            this.hasResults = false;
            
            // Reset progress
            this.progressSteps.forEach(step => {
                step.status = 'todo';
                step.timestamp = '';
                step.logs = [];
            });
            
            try {
                // Start the screening process
                const response = await fetch('/api/individual-screen', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: this.form.fullName,
                        date_of_birth: this.form.dateOfBirth,
                        countries: this.form.countries.join(','),
                        nationality: this.form.nationality,
                        id_type: this.form.idType,
                        id_number: this.form.idNumber,
                        scopes: this.form.scopes,
                        fuzzy_threshold: this.form.fuzzyThreshold
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Screening failed');
                }
                
                const data = await response.json();
                
                // Simulate progress updates
                await this.simulateProgress();
                
                // Process results
                this.processResults(data);
                this.hasResults = true;
                
            } catch (error) {
                console.error('Screening error:', error);
                alert('Screening failed: ' + error.message);
            } finally {
                this.isScreening = false;
            }
        },
        
        async simulateProgress() {
            for (let i = 0; i < this.progressSteps.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                this.progressSteps[i].status = 'doing';
                this.progressSteps[i].timestamp = new Date().toLocaleTimeString();
                this.progressSteps[i].logs = [
                    { id: 1, message: 'Starting process...' },
                    { id: 2, message: 'Processing data...' }
                ];
                
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                this.progressSteps[i].status = 'done';
                this.progressSteps[i].timestamp = new Date().toLocaleTimeString();
                this.progressSteps[i].logs.push({ id: 3, message: 'Completed successfully' });
            }
        },
        
        processResults(data) {
            // Process the screening results
            this.results = {
                fullName: this.form.fullName,
                dateOfBirth: this.form.dateOfBirth,
                riskScore: this.calculateRiskScore(data),
                dataSources: data.data_sources || [],
                // Store complete Dilisense data for raw display
                dilisenseData: data.dilisense || {}
            };
        },
        
        calculateRiskScore(data) {
            // Calculate risk score based on findings
            let score = 0;
            
            if (data.dilisense && !data.dilisense.error) {
                if (data.dilisense.sanctions && data.dilisense.sanctions.total_hits > 0) {
                    score += 60;
                }
                if (data.dilisense.pep && data.dilisense.pep.total_hits > 0) {
                    score += 25;
                }
                if (data.dilisense.adverse_media && data.dilisense.adverse_media.total_hits > 0) {
                    score += 15;
                }
            }
            
            return Math.min(score, 100);
        },
        
        extractSanctions(data) {
            if (data.dilisense && !data.dilisense.error && data.dilisense.sanctions) {
                return data.dilisense.sanctions.found_records || [];
            }
            return [];
        },
        
        extractPEP(data) {
            if (data.dilisense && !data.dilisense.error && data.dilisense.pep) {
                return data.dilisense.pep.found_records || [];
            }
            return [];
        },
        
        extractAdverseMedia(data) {
            if (data.dilisense && !data.dilisense.error && data.dilisense.adverse_media) {
                return data.dilisense.adverse_media.found_records || [];
            }
            return [];
        },
        
        extractCriminal(data) {
            if (data.dilisense && !data.dilisense.error && data.dilisense.criminal) {
                return data.dilisense.criminal.found_records || [];
            }
            return [];
        },
        
        extractOther(data) {
            if (data.dilisense && !data.dilisense.error && data.dilisense.other) {
                return data.dilisense.other.found_records || [];
            }
            return [];
        },
        
        getRiskClass(score) {
            if (score >= 70) return 'risk-high';
            if (score >= 40) return 'risk-medium';
            return 'risk-low';
        },
        
        getRiskLevel(score) {
            if (score >= 70) return 'HIGH';
            if (score >= 40) return 'MEDIUM';
            return 'LOW';
        },
        
        selectHit(hit) {
            this.selectedHit = hit;
        },

        downloadResults() {
            const data = JSON.stringify(this.results.dilisenseData, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dilisense_results.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    };
}
</script>
{% endblock %}
