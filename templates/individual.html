{% extends "_base.html" %}

{% block content %}
<section class="grid gap-6">
    <!-- Individual Screening Form -->
    <div class="surface p-6">
        <div class="text-lg font-semibold mb-4">Individual Screening</div>
        <form id="indForm" class="grid md:grid-cols-2 gap-4">
            <!-- Personal Information -->
            <div>
                <label class="text-sm text-[var(--text-1)]">Full Name *</label>
                <input name="fullName" class="input w-full" required placeholder="e.g., John Doe">
            </div>
            <div>
                <label class="text-sm text-[var(--text-1)]">Date of Birth</label>
                <input name="dob" type="date" class="input w-full">
            </div>
            <div>
                <label class="text-sm text-[var(--text-1)]">Nationality</label>
                <input name="nationality" class="input w-full" placeholder="e.g., Saudi">
            </div>
            <div>
                <label class="text-sm text-[var(--text-1)]">ID Number</label>
                <input name="idNumber" class="input w-full" placeholder="Passport, National ID, etc.">
            </div>
            
            <!-- Additional Fields -->
            <div>
                <label class="text-sm text-[var(--text-1)]">Occupation</label>
                <input name="occupation" class="input w-full" placeholder="e.g., Business Executive">
            </div>
            <div>
                <label class="text-sm text-[var(--text-1)]">Company</label>
                <input name="company" class="input w-full" placeholder="Current employer">
            </div>
            
            <!-- Action Buttons -->
            <div class="md:col-span-2 flex gap-3 mt-2">
                <button class="btn" type="submit">
                    <span class="mr-2">üîç</span>Run Screening
                </button>
                <button type="button" class="btn-ghost" id="btnExport">
                    <span class="mr-2">üì•</span>Export Results
                </button>
            </div>
        </form>
    </div>

    <!-- Results Section with Tabs -->
    <div class="surface p-6">
        <div class="border-b border-white/10 mb-4">
            <nav class="flex gap-6">
                <button type="button" id="tab-details-ind" class="py-2 border-b-2 border-accent-blue text-accent-blue">Details</button>
                <button type="button" id="tab-overall-ind" class="py-2 text-[var(--text-1)] hover:text-white/90">Overall Results</button>
            </nav>
        </div>

        <!-- Details Panel (existing renderer) -->
        <div id="panel-details-ind">
            {% include "partials/_results.html" %}
        </div>

        <!-- Overall Results Panel (aggregated raw response) -->
        <div id="panel-overall-ind" class="hidden">
            <div class="text-sm text-[var(--text-1)] mb-2">Complete API Response</div>
            <pre id="overall-json-ind" class="bg-[var(--bg-2)] p-4 rounded-xl overflow-auto text-sm leading-relaxed">‚Äî</pre>
        </div>
    </div>
</section>

<script>
const form = document.getElementById('indForm');

form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const payload = Object.fromEntries(new FormData(form).entries());
    
    showSkeleton(true);
    
    try {
        const res = await fetch('/api/individual-screen', {
            method: 'POST',
            credentials: 'include',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        const data = await res.json();
        
        if (!res.ok) {
            toast('Error: ' + (data.error || 'request failed'), 'error');
            return;
        }
        
        // Save full response and show in Overall tab
        try {
            window.__last_api_ind__ = data;
            const overallEl = document.getElementById('overall-json-ind');
            if (overallEl) overallEl.textContent = JSON.stringify(data, null, 2);
            if (typeof window.__showPanelInd === 'function') {
                window.__showPanelInd('overall');
            }
        } catch (_) {}

        renderIndividualResults(data);
        toast('Individual screening completed successfully', 'success');
        
    } catch (error) {
        toast('Network error: ' + error.message, 'error');
    } finally {
        showSkeleton(false);
    }
});

// Export handler
document.getElementById('btnExport').addEventListener('click', exportReport);

// Simple tabs for Individual Details / Overall Results
function initIndividualTabs() {
    const tabDetails = document.getElementById('tab-details-ind');
    const tabOverall = document.getElementById('tab-overall-ind');
    const panelDetails = document.getElementById('panel-details-ind');
    const panelOverall = document.getElementById('panel-overall-ind');

    if (!tabDetails || !tabOverall || !panelDetails || !panelOverall) return;

    function showPanelInd(which) {
        const isOverall = which === 'overall';
        panelOverall.classList.toggle('hidden', !isOverall);
        panelDetails.classList.toggle('hidden', isOverall);
        // styling
        if (isOverall) {
            tabOverall.classList.add('border-b-2','border-accent-blue','text-accent-blue');
            tabOverall.classList.remove('text-[var(--text-1)]');
            tabDetails.classList.remove('border-b-2','border-accent-blue','text-accent-blue');
            tabDetails.classList.add('text-[var(--text-1)]');
        } else {
            tabDetails.classList.add('border-b-2','border-accent-blue','text-accent-blue');
            tabDetails.classList.remove('text-[var(--text-1)]');
            tabOverall.classList.remove('border-b-2','border-accent-blue','text-accent-blue');
            tabOverall.classList.add('text-[var(--text-1)]');
        }
    }

    tabDetails.addEventListener('click', (e) => { e.preventDefault(); showPanelInd('details'); });
    tabOverall.addEventListener('click', (e) => { e.preventDefault(); showPanelInd('overall'); });

    // expose for use after API
    window.__showPanelInd = showPanelInd;
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initIndividualTabs);
} else {
    initIndividualTabs();
}
</script>
{% endblock %}
