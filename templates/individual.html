{% extends "_base.html" %}

{% block content %}
<section class="grid gap-6">
    <!-- KPI Dashboard -->
    <div class="grid md:grid-cols-4 gap-4">
        <div class="kpi-tile">
            <div class="text-sm text-[var(--text-1)]">Overall Risk</div>
            <div class="text-2xl font-bold font-mono" id="kpi-overall">‚Äî</div>
        </div>
        <div class="kpi-tile">
            <div class="text-sm text-[var(--text-1)]">Sanctions</div>
            <div class="text-xl font-mono" id="kpi-sanc">‚Äî</div>
        </div>
        <div class="kpi-tile">
            <div class="text-sm text-[var(--text-1)]">PEP</div>
            <div class="text-xl font-mono" id="kpi-pep">‚Äî</div>
        </div>
        <div class="kpi-tile">
            <div class="text-sm text-[var(--text-1)]">Criminal</div>
            <div class="text-xl font-mono" id="kpi-adv">‚Äî</div>
        </div>
    </div>

    <!-- Individual Screening Form -->
    <div class="surface p-6">
        <div class="text-lg font-semibold mb-4">Individual Screening</div>
        <form id="indForm" class="grid md:grid-cols-2 gap-4">
            <!-- Personal Information -->
            <div>
                <label class="text-sm text-[var(--text-1)]">Full Name *</label>
                <input name="fullName" class="input w-full" required placeholder="e.g., Boris Johnson">
            </div>
            <div>
                <label class="text-sm text-[var(--text-1)]">Date of Birth</label>
                <input name="dob" type="date" class="input w-full">
            </div>
            <div>
                <label class="text-sm text-[var(--text-1)]">Nationality</label>
                <input name="nationality" class="input w-full" placeholder="e.g., British">
            </div>
            <div>
                <label class="text-sm text-[var(--text-1)]">ID Number</label>
                <input name="idNumber" class="input w-full" placeholder="Passport, National ID, etc.">
            </div>
            
            <!-- Action Buttons -->
            <div class="md:col-span-2 flex gap-3 mt-2">
                <button class="btn" type="submit">
                    <span class="mr-2">üîç</span>Run Screening
                </button>
                <button type="button" class="btn-ghost" id="btnExportInd">
                    <span class="mr-2">üì•</span>Export Results
                </button>
            </div>
        </form>
    </div>

    <!-- Results Section with Simple Tabs -->
    <div class="surface p-6" id="resultsContainerInd" style="display: none;">
        <!-- Tab Navigation -->
        <div class="border-b border-white/10 mb-6">
            <nav class="flex gap-6">
                <button type="button" class="tab-btn-ind active" data-tab="summary">
                    üìä Summary
                </button>
                <button type="button" class="tab-btn-ind" data-tab="compliance">
                    ‚öñÔ∏è Compliance
                </button>
                <button type="button" class="tab-btn-ind" data-tab="raw">
                    üìÑ Raw JSON
                </button>
            </nav>
        </div>

        <!-- Summary Tab -->
        <div class="tab-content-ind" id="tab-summary-ind">
            <div class="grid gap-6">
                <!-- Person Info -->
                <div class="surface p-4">
                    <div class="text-sm text-[var(--text-1)] mb-2">Person Information</div>
                    <div id="person-info" class="text-[var(--text-0)]">‚Äî</div>
                </div>
                
                <!-- Risk Summary -->
                <div class="surface p-4">
                    <div class="text-sm text-[var(--text-1)] mb-2">Risk Summary</div>
                    <div id="risk-summary" class="text-[var(--text-0)]">‚Äî</div>
                </div>
            </div>
        </div>

        <!-- Compliance Tab -->
        <div class="tab-content-ind hidden" id="tab-compliance-ind">
            <div class="grid gap-6">
                <div class="surface p-4">
                    <div class="text-sm text-[var(--text-1)] mb-2">Sanctions Records</div>
                    <div id="compliance-sanctions" class="text-[var(--text-0)] text-sm">‚Äî</div>
                </div>
                <div class="surface p-4">
                    <div class="text-sm text-[var(--text-1)] mb-2">PEP Records</div>
                    <div id="compliance-pep" class="text-[var(--text-0)] text-sm">‚Äî</div>
                </div>
                <div class="surface p-4">
                    <div class="text-sm text-[var(--text-1)] mb-2">Criminal Records</div>
                    <div id="compliance-criminal" class="text-[var(--text-0)] text-sm">‚Äî</div>
                </div>
            </div>
        </div>

        <!-- Raw JSON Tab -->
        <div class="tab-content-ind hidden" id="tab-raw-ind">
            <div class="surface p-4">
                <div class="text-sm text-[var(--text-1)] mb-2">Complete API Response</div>
                <pre id="raw-json-ind" class="bg-[var(--bg-2)] p-4 rounded-xl overflow-auto text-xs leading-relaxed" style="max-height: 600px;">‚Äî</pre>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingStateInd" class="surface p-6 text-center" style="display: none;">
        <div class="text-lg">üîç Screening in progress...</div>
        <div class="text-sm text-[var(--text-1)] mt-2">Checking compliance databases...</div>
    </div>
</section>

<style>
.tab-btn-ind {
    padding: 12px 16px;
    border-bottom: 2px solid transparent;
    color: var(--text-1);
    transition: all 0.2s ease;
    cursor: pointer;
    background: none;
    border-top: none;
    border-left: none;
    border-right: none;
}
.tab-btn-ind:hover {
    color: var(--text-0);
}
.tab-btn-ind.active {
    color: #3b82f6;
    border-bottom-color: #3b82f6;
}
</style>

<script>
// Simple tab system for individual
function initIndividualTabs() {
    const tabBtns = document.querySelectorAll('.tab-btn-ind');
    const tabContents = document.querySelectorAll('.tab-content-ind');
    
    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const targetTab = btn.getAttribute('data-tab');
            
            // Update button states
            tabBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // Update content visibility
            tabContents.forEach(content => {
                if (content.id === `tab-${targetTab}-ind`) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });
        });
    });
}

// Form submission
const form = document.getElementById('indForm');
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const payload = Object.fromEntries(new FormData(form).entries());
    
    // Show loading
    document.getElementById('resultsContainerInd').style.display = 'none';
    document.getElementById('loadingStateInd').style.display = 'block';
    
    try {
        // Login first
        await fetch('/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'username=admin&password=change-me',
            credentials: 'include'
        });
        
        const res = await fetch('/api/individual-screen', {
            method: 'POST',
            credentials: 'include',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        const data = await res.json();
        
        if (!res.ok) {
            alert('Error: ' + (data.error || 'request failed'));
            return;
        }
        
        // Show results and populate
        document.getElementById('loadingStateInd').style.display = 'none';
        document.getElementById('resultsContainerInd').style.display = 'block';
        
        // Populate all tabs
        populateIndividualResults(data);
        
        // Auto-switch to Raw JSON tab to show data
        document.querySelector('.tab-btn-ind[data-tab="raw"]').click();
        
    } catch (error) {
        alert('Network error: ' + error.message);
    } finally {
        document.getElementById('loadingStateInd').style.display = 'none';
    }
});

function populateIndividualResults(data) {
    try {
        // Raw JSON tab
        document.getElementById('raw-json-ind').textContent = JSON.stringify(data, null, 2);
        
        // Summary tab
        const dilisense = data.dilisense || {};
        
        document.getElementById('person-info').innerHTML = `
            <div><strong>Name:</strong> ${data.name || '‚Äî'}</div>
            <div><strong>Country:</strong> ${data.country || '‚Äî'}</div>
            <div><strong>Total Hits:</strong> ${dilisense.total_hits || 0}</div>
        `;
        
        document.getElementById('risk-summary').innerHTML = `
            <div><strong>Risk Score:</strong> ${data.risk_score || 0}</div>
            <div><strong>Risk Level:</strong> ${data.overall_risk_level || 'Low'}</div>
            <div><strong>Risk Factors:</strong> ${(data.risk_factors || []).join(', ') || 'None'}</div>
        `;
        
        // Compliance tab
        const sanctions = dilisense.sanctions?.found_records || [];
        const pep = dilisense.pep?.found_records || [];
        const criminal = dilisense.criminal?.found_records || [];
        
        document.getElementById('compliance-sanctions').innerHTML = sanctions.length === 0 ? 'No sanctions found' :
            sanctions.slice(0, 5).map(r => `
                <div class="mb-2 p-2 bg-red-900/20 rounded">
                    <div><strong>${r.name || 'Unknown'}</strong></div>
                    <div class="text-xs">Source: ${r.source_id || 'Unknown'}</div>
                    <div class="text-xs">Country: ${r.source_country || 'Unknown'}</div>
                </div>
            `).join('');
        
        document.getElementById('compliance-pep').innerHTML = pep.length === 0 ? 'No PEP records found' :
            pep.slice(0, 5).map(r => `
                <div class="mb-2 p-2 bg-yellow-900/20 rounded">
                    <div><strong>${r.name || 'Unknown'}</strong></div>
                    <div class="text-xs">Type: ${r.pep_type || 'PEP'}</div>
                    <div class="text-xs">Source: ${r.source_id || 'Unknown'}</div>
                </div>
            `).join('');
        
        document.getElementById('compliance-criminal').innerHTML = criminal.length === 0 ? 'No criminal records found' :
            criminal.slice(0, 5).map(r => `
                <div class="mb-2 p-2 bg-red-900/20 rounded">
                    <div><strong>${r.name || 'Unknown'}</strong></div>
                    <div class="text-xs">Source: ${r.source_id || 'Unknown'}</div>
                </div>
            `).join('');
        
        // Update top KPIs
        document.getElementById('kpi-overall').textContent = data.overall_risk_level || 'Low';
        document.getElementById('kpi-sanc').textContent = sanctions.length;
        document.getElementById('kpi-pep').textContent = pep.length;
        document.getElementById('kpi-adv').textContent = criminal.length;
        
    } catch (error) {
        console.error('Error populating individual results:', error);
        document.getElementById('raw-json-ind').textContent = 'Error: ' + error.message;
    }
}

// Initialize tabs when page loads
document.addEventListener('DOMContentLoaded', initIndividualTabs);

// Export handler
document.getElementById('btnExportInd').addEventListener('click', () => {
    const data = document.getElementById('raw-json-ind').textContent;
    if (data && data !== '‚Äî') {
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `individual_screening_${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
});
</script>
{% endblock %}