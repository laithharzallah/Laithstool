{% extends "_base.html" %}
{% block page_title %}UK Companies House{% endblock %}
{% block page_description %}Search UK company profile, officers, and PSCs{% endblock %}
{% block content %}
<div x-data="ukch()" class="space-y-6">
  <div class="metric-card">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="text-sm text-gray-500">Company number</label>
        <input x-model="companyNumber" class="input-field" placeholder="e.g., 00000006" />
      </div>
      <div>
        <label class="text-sm text-gray-500">Or search query</label>
        <input x-model="query" class="input-field" placeholder="e.g., HSBC" />
      </div>
      <div class="flex items-end">
        <button @click="run()" class="btn-primary w-full">Fetch</button>
      </div>
    </div>
    <div class="mt-3 text-xs text-gray-500">Set env UK_CH_API_KEY or COMPANIES_HOUSE_API_KEY.</div>
  </div>

  <template x-if="error">
    <div class="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-200 p-4 rounded-lg" x-text="error"></div>
  </template>

  <template x-if="mode==='search'">
    <div class="metric-card">
      <h3 class="font-semibold mb-3">Matches</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <template x-for="it in searchItems" :key="it.company_number">
          <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
            <div class="font-medium" x-text="it.title"></div>
            <div class="text-xs text-gray-500 mt-1">Company No: <span x-text="it.company_number"></span></div>
            <button class="btn-secondary mt-3" @click="companyNumber=it.company_number; run()">Open</button>
          </div>
        </template>
      </div>
    </div>
  </template>

  <template x-if="mode==='detail'">
    <div class="space-y-6">
      <div class="metric-card">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold">Key Executives (Officers)</h3>
          <span class="text-xs text-gray-500" x-text="officers.length + ' total'"></span>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <template x-for="o in officers" :key="o?.links?.officer?.appointments">
            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
              <div class="font-medium" x-text="o?.name || '—'"></div>
              <div class="text-xs text-gray-500 mt-1" x-text="o?.officer_role || '—'"></div>
              <div class="text-xs text-gray-400" x-text="(o?.appointed_on ? ('Appointed: ' + o.appointed_on) : '')"></div>
            </div>
          </template>
        </div>
      </div>

      <div class="metric-card">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold">Persons with Significant Control (Shareholders/UBOs)</h3>
          <span class="text-xs text-gray-500" x-text="psc.length + ' total'"></span>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <template x-for="p in psc" :key="p?.etag">
            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
              <div class="font-medium" x-text="p?.name || p?.ceased?.name || (p?.natures_of_control || []).join(', ') || '—'"></div>
              <div class="text-xs text-gray-500 mt-1" x-text="(p?.natures_of_control || []).join(', ')"></div>
              <div class="text-xs text-gray-400" x-text="p?.notified_on ? ('Notified: ' + p.notified_on) : ''"></div>
            </div>
          </template>
        </div>
      </div>

    </div>
  </template>
</div>

<script>
function ukch() {
  return {
    query: '',
    companyNumber: '',
    error: '',
    json: '',
    showRaw: false,
    mode: '',
    searchItems: [],
    profile: null,
    roAddress: null,
    officers: [],
    psc: [],
    fullAddress() {
      const a = this.roAddress || this.profile?.registered_office_address;
      if (!a) return '—';
      return [a.address_line_1, a.address_line_2, a.locality, a.region, a.postal_code, a.country].filter(Boolean).join(', ');
    },
    async run() {
      this.error = '';
      this.json = '';
      this.mode = '';
      this.searchItems = [];
      this.profile = null;
      this.roAddress = null;
      this.officers = [];
      this.psc = [];
      try {
        const body = {};
        if (this.companyNumber.trim()) body.company_number = this.companyNumber.trim();
        if (this.query.trim()) body.query = this.query.trim();
        const res = await fetch('/api/ukch/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok || data.error) throw new Error(data.error || 'Request failed');
        this.json = JSON.stringify(data, null, 2);
        if (data.mode === 'search') {
          this.mode = 'search';
          this.searchItems = data.items || [];
        } else {
          this.mode = 'detail';
          this.profile = data.profile || {};
          this.roAddress = data.registered_office_address || null;
          this.officers = (data.officers && data.officers.items) || [];
          this.psc = (data.psc && data.psc.items) || [];
        }
      } catch (e) {
        this.error = e.message;
      }
    }
  }
}
</script>
{% endblock %}
