<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPRM - Company Screening</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/enhanced-json-viewer.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.10.3/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.3.3/dist/echarts.min.js"></script>
    <script src="{{ url_for('static', filename='js/enhanced-json-viewer.js') }}"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8" x-data="companyScreening()">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-blue-400">TPRM Company Screening</h1>
                <div class="flex space-x-4">
                    <a href="/" class="text-blue-400 hover:text-blue-300">Home</a>
                    <a href="/enhanced/individual_screening" class="text-blue-400 hover:text-blue-300">Individual Screening</a>
                    <a href="/enhanced/dart_registry" class="text-blue-400 hover:text-blue-300">DART Registry</a>
                </div>
            </div>
            <p class="text-gray-400 mt-2">Screen companies for third-party risk management</p>
        </header>

        <!-- Screening Form -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8 shadow-lg" x-show="!isLoading && !results">
            <h2 class="text-xl font-semibold mb-4 text-blue-300">Company Information</h2>
            <form @submit.prevent="startScreening" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="company" class="block text-sm font-medium text-gray-300 mb-1">Company Name *</label>
                        <input type="text" id="company" x-model="formData.company" required
                            class="w-full px-4 py-2 rounded-md bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="country" class="block text-sm font-medium text-gray-300 mb-1">Country</label>
                        <input type="text" id="country" x-model="formData.country"
                            class="w-full px-4 py-2 rounded-md bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="domain" class="block text-sm font-medium text-gray-300 mb-1">Domain</label>
                        <input type="text" id="domain" x-model="formData.domain"
                            class="w-full px-4 py-2 rounded-md bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="level" class="block text-sm font-medium text-gray-300 mb-1">Screening Level</label>
                        <select id="level" x-model="formData.level"
                            class="w-full px-4 py-2 rounded-md bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="basic">Basic</option>
                            <option value="standard" selected>Standard</option>
                            <option value="enhanced">Enhanced</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                    <button type="submit"
                        class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-md font-medium transition-colors duration-200">
                        Start Screening
                    </button>
                </div>
            </form>
        </div>

        <!-- Loading State -->
        <div class="bg-gray-800 rounded-lg p-8 mb-8 shadow-lg text-center" x-show="isLoading">
            <div class="flex flex-col items-center justify-center">
                <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                <h2 class="text-xl font-semibold mb-2 text-blue-300">Screening in Progress</h2>
                <p class="text-gray-400" x-text="loadingMessage"></p>
            </div>
        </div>

        <!-- Results -->
        <div class="bg-gray-800 rounded-lg shadow-lg" x-show="results" x-cloak>
            <!-- Results Header -->
            <div class="p-6 border-b border-gray-700">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-blue-300" x-text="results.company_name"></h2>
                        <p class="text-gray-400 mt-1" x-text="results.country"></p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-400">Risk Level:</span>
                        <span class="px-3 py-1 rounded-full text-sm font-medium"
                            :class="{
                                'bg-red-900/30 text-red-400': results.overall_risk_level === 'High',
                                'bg-yellow-900/30 text-yellow-400': results.overall_risk_level === 'Medium',
                                'bg-green-900/30 text-green-400': results.overall_risk_level === 'Low'
                            }"
                            x-text="results.overall_risk_level"></span>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="border-b border-gray-700">
                <nav class="flex overflow-x-auto" aria-label="Tabs">
                    <button @click="activeTab = 'overview'" 
                        class="px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 transition-colors duration-200"
                        :class="activeTab === 'overview' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400 hover:text-gray-300'">
                        Overview
                    </button>
                    <button @click="activeTab = 'company'" 
                        class="px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 transition-colors duration-200"
                        :class="activeTab === 'company' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400 hover:text-gray-300'">
                        Company Profile
                    </button>
                    <button @click="activeTab = 'executives'" 
                        class="px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 transition-colors duration-200"
                        :class="activeTab === 'executives' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400 hover:text-gray-300'">
                        Key People
                    </button>
                    <button @click="activeTab = 'risk'" 
                        class="px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 transition-colors duration-200"
                        :class="activeTab === 'risk' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400 hover:text-gray-300'">
                        Risk Factors
                    </button>
                    <button @click="activeTab = 'raw'" 
                        class="px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 transition-colors duration-200"
                        :class="activeTab === 'raw' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400 hover:text-gray-300'">
                        Raw Data
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                <!-- Overview Tab -->
                <div x-show="activeTab === 'overview'">
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-blue-300 mb-3">Executive Summary</h3>
                        <p class="text-gray-300" x-text="results.executive_summary"></p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-gray-700/50 rounded-lg p-4 flex flex-col items-center">
                            <div class="text-3xl font-bold mb-2" x-text="results.metrics?.sanctions || 0"
                                :class="{
                                    'text-red-400': (results.metrics?.sanctions || 0) > 0,
                                    'text-green-400': (results.metrics?.sanctions || 0) === 0
                                }"></div>
                            <div class="text-sm text-gray-400">Sanctions</div>
                        </div>
                        <div class="bg-gray-700/50 rounded-lg p-4 flex flex-col items-center">
                            <div class="text-3xl font-bold mb-2" x-text="results.metrics?.adverse_media || 0"
                                :class="{
                                    'text-red-400': (results.metrics?.adverse_media || 0) > 5,
                                    'text-yellow-400': (results.metrics?.adverse_media || 0) > 0 && (results.metrics?.adverse_media || 0) <= 5,
                                    'text-green-400': (results.metrics?.adverse_media || 0) === 0
                                }"></div>
                            <div class="text-sm text-gray-400">Adverse Media</div>
                        </div>
                        <div class="bg-gray-700/50 rounded-lg p-4 flex flex-col items-center">
                            <div class="text-3xl font-bold mb-2" x-text="results.executives?.length || 0"
                                class="text-blue-400"></div>
                            <div class="text-sm text-gray-400">Key Executives</div>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-blue-300 mb-3">Company Information</h3>
                        <div class="bg-gray-700/30 rounded-lg overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-700">
                                <tbody class="divide-y divide-gray-700">
                                    <tr>
                                        <td class="px-4 py-3 text-sm font-medium text-gray-400">Industry</td>
                                        <td class="px-4 py-3 text-sm text-gray-300" x-text="results.industry || 'N/A'"></td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-3 text-sm font-medium text-gray-400">Founded</td>
                                        <td class="px-4 py-3 text-sm text-gray-300" x-text="results.founded_year || 'N/A'"></td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-3 text-sm font-medium text-gray-400">Headquarters</td>
                                        <td class="px-4 py-3 text-sm text-gray-300" x-text="results.headquarters || 'N/A'"></td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-3 text-sm font-medium text-gray-400">Website</td>
                                        <td class="px-4 py-3 text-sm text-gray-300" x-text="results.website || 'N/A'"></td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-3 text-sm font-medium text-gray-400">Legal Form</td>
                                        <td class="px-4 py-3 text-sm text-gray-300" x-text="results.legal_form || 'N/A'"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="mb-8" x-show="results.real_data && results.real_data.ownership_structure">
                        <h3 class="text-lg font-semibold text-blue-300 mb-3">Ownership Structure</h3>
                        <div class="bg-gray-700/30 rounded-lg overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead>
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Shareholder</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Ownership</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-700">
                                    <template x-for="owner in results.real_data.ownership_structure" :key="owner.name">
                                        <tr>
                                            <td class="px-4 py-3 text-sm text-gray-300" x-text="owner.name"></td>
                                            <td class="px-4 py-3 text-sm text-gray-300" x-text="owner.percentage"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold text-blue-300 mb-3">Risk Assessment</h3>
                        <div class="bg-gray-700/30 rounded-lg p-4">
                            <p class="text-gray-300" x-text="results.risk_assessment"></p>
                        </div>
                    </div>
                </div>

                <!-- Company Profile Tab -->
                <div x-show="activeTab === 'company'">
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-blue-300 mb-3">Company Profile</h3>
                        <div class="bg-gray-700/30 rounded-lg p-4">
                            <p class="text-gray-300" x-text="results.company_profile || 'No company profile available.'"></p>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-blue-300 mb-3">Business Activities</h3>
                        <div class="bg-gray-700/30 rounded-lg p-4">
                            <p class="text-gray-300" x-text="results.business_activities || 'No business activities information available.'"></p>
                        </div>
                    </div>

                    <div class="mb-8" x-show="results.real_data && results.real_data.notable_projects">
                        <h3 class="text-lg font-semibold text-blue-300 mb-3">Notable Projects</h3>
                        <div class="bg-gray-700/30 rounded-lg p-4">
                            <ul class="list-disc pl-5 text-gray-300">
                                <template x-for="project in results.real_data.notable_projects" :key="project">
                                    <li x-text="project" class="mb-1"></li>
                                </template>
                            </ul>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold text-blue-300 mb-3">Jurisdictions</h3>
                        <div class="bg-gray-700/30 rounded-lg p-4">
                            <div class="flex flex-wrap gap-2">
                                <template x-for="jurisdiction in results.jurisdictions" :key="jurisdiction">
                                    <span class="px-3 py-1 bg-gray-600 rounded-full text-sm text-gray-300" x-text="jurisdiction"></span>
                                </template>
                                <span x-show="!results.jurisdictions || results.jurisdictions.length === 0" class="text-gray-400">No jurisdictions information available.</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Executives Tab -->
                <div x-show="activeTab === 'executives'">
                    <h3 class="text-lg font-semibold text-blue-300 mb-3">Key Executives</h3>
                    
                    <div class="bg-gray-700/30 rounded-lg overflow-hidden" x-show="results.executives && results.executives.length > 0">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Name</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Position</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Risk Level</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-700">
                                <template x-for="executive in results.executives" :key="executive.name + executive.position">
                                    <tr>
                                        <td class="px-4 py-3 text-sm text-gray-300" x-text="executive.name"></td>
                                        <td class="px-4 py-3 text-sm text-gray-300" x-text="executive.position"></td>
                                        <td class="px-4 py-3">
                                            <span class="px-2 py-1 rounded-full text-xs font-medium"
                                                :class="{
                                                    'bg-red-900/30 text-red-400': executive.risk_level === 'High',
                                                    'bg-yellow-900/30 text-yellow-400': executive.risk_level === 'Medium',
                                                    'bg-green-900/30 text-green-400': executive.risk_level === 'Low'
                                                }"
                                                x-text="executive.risk_level"></span>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="bg-gray-700/30 rounded-lg p-4 text-gray-400" x-show="!results.executives || results.executives.length === 0">
                        No executive information available.
                    </div>
                </div>

                <!-- Risk Factors Tab -->
                <div x-show="activeTab === 'risk'">
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-blue-300 mb-3">Sanctions</h3>
                        <div class="bg-gray-700/30 rounded-lg p-4">
                            <div x-show="results.sanctions && results.sanctions.length > 0">
                                <table class="min-w-full divide-y divide-gray-700">
                                    <thead>
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Authority</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Type</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Date</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-700">
                                        <template x-for="sanction in results.sanctions" :key="sanction.id">
                                            <tr>
                                                <td class="px-4 py-3 text-sm text-gray-300" x-text="sanction.authority"></td>
                                                <td class="px-4 py-3 text-sm text-gray-300" x-text="sanction.type"></td>
                                                <td class="px-4 py-3 text-sm text-gray-300" x-text="sanction.date"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                            <div x-show="!results.sanctions || results.sanctions.length === 0" class="text-gray-400">
                                No sanctions found.
                            </div>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-blue-300 mb-3">Adverse Media</h3>
                        <div class="bg-gray-700/30 rounded-lg p-4">
                            <div x-show="results.adverse_media && results.adverse_media.length > 0">
                                <div class="space-y-4">
                                    <template x-for="media in results.adverse_media" :key="media.id">
                                        <div class="border-b border-gray-700 pb-4 last:border-0 last:pb-0">
                                            <h4 class="font-medium text-gray-200 mb-1" x-text="media.title"></h4>
                                            <p class="text-sm text-gray-400 mb-2" x-text="media.date"></p>
                                            <p class="text-gray-300" x-text="media.summary"></p>
                                            <a :href="media.url" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm mt-2 inline-block">Source</a>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <div x-show="!results.adverse_media || results.adverse_media.length === 0" class="text-gray-400">
                                No adverse media found.
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold text-blue-300 mb-3">Citations</h3>
                        <div class="bg-gray-700/30 rounded-lg p-4">
                            <div x-show="results.citations && results.citations.length > 0">
                                <ul class="space-y-2">
                                    <template x-for="citation in results.citations" :key="citation.url">
                                        <li>
                                            <a :href="citation.url" target="_blank" class="text-blue-400 hover:text-blue-300" x-text="citation.title"></a>
                                        </li>
                                    </template>
                                </ul>
                            </div>
                            <div x-show="!results.citations || results.citations.length === 0" class="text-gray-400">
                                No citations available.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Raw Data Tab -->
                <div x-show="activeTab === 'raw'">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-blue-300">Raw Data</h3>
                        <div class="flex space-x-2">
                            <button @click="copyRawData" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm">
                                Copy
                            </button>
                            <button @click="exportRawData" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm">
                                Export
                            </button>
                        </div>
                    </div>
                    
                    <!-- Enhanced JSON Viewer -->
                    <div id="json-viewer" class="json-viewer" data-theme="dark"></div>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-6 border-t border-gray-700 flex justify-between items-center">
                <div class="text-sm text-gray-400">
                    Screening completed at <span x-text="formatTimestamp(results.timestamp)"></span>
                </div>
                <button @click="resetForm" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-md text-sm transition-colors duration-200">
                    New Screening
                </button>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-12 text-center text-gray-500 text-sm">
            <p>&copy; 2025 TPRM Tool. All rights reserved.</p>
        </footer>
    </div>

    <script>
        function companyScreening() {
            return {
                formData: {
                    company: '',
                    country: '',
                    domain: '',
                    level: 'standard'
                },
                isLoading: false,
                loadingMessage: 'Initializing screening...',
                results: null,
                activeTab: 'overview',
                loadingMessages: [
                    'Searching for company information...',
                    'Analyzing company structure...',
                    'Checking sanctions lists...',
                    'Scanning for adverse media...',
                    'Evaluating risk factors...',
                    'Compiling executive profiles...',
                    'Finalizing risk assessment...'
                ],
                loadingInterval: null,
                
                startScreening() {
                    this.isLoading = true;
                    this.loadingMessage = this.loadingMessages[0];
                    let messageIndex = 1;
                    
                    // Simulate loading with changing messages
                    this.loadingInterval = setInterval(() => {
                        if (messageIndex < this.loadingMessages.length) {
                            this.loadingMessage = this.loadingMessages[messageIndex];
                            messageIndex++;
                        }
                    }, 1500);
                    
                    // Make API call
                    fetch('/api/screen', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(this.formData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        clearInterval(this.loadingInterval);
                        this.results = data;
                        this.isLoading = false;
                        this.activeTab = 'overview';
                        
                        // Initialize the enhanced JSON viewer
                        setTimeout(() => {
                            const jsonViewer = document.getElementById('json-viewer');
                            if (jsonViewer) {
                                jsonViewer.setAttribute('data-json', JSON.stringify(data));
                                new EnhancedJsonViewer({
                                    container: jsonViewer,
                                    data: data,
                                    theme: 'dark'
                                });
                            }
                        }, 100);
                    })
                    .catch(error => {
                        clearInterval(this.loadingInterval);
                        this.isLoading = false;
                        alert('Error: ' + error.message);
                    });
                },
                
                resetForm() {
                    this.results = null;
                    this.formData = {
                        company: '',
                        country: '',
                        domain: '',
                        level: 'standard'
                    };
                },
                
                formatTimestamp(timestamp) {
                    if (!timestamp) return 'Unknown';
                    const date = new Date(timestamp);
                    return date.toLocaleString();
                },
                
                copyRawData() {
                    navigator.clipboard.writeText(JSON.stringify(this.results, null, 2))
                        .then(() => alert('Raw data copied to clipboard'))
                        .catch(err => alert('Failed to copy: ' + err));
                },
                
                exportRawData() {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.results, null, 2));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", `${this.results.company_name.replace(/\s+/g, '_')}_screening.json`);
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                }
            };
        }
    </script>
</body>
</html>
