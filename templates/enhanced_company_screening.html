<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPRM - Company Screening</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/enhanced-json-viewer.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.10.3/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.3.3/dist/echarts.min.js"></script>
    <script src="{{ url_for('static', filename='js/enhanced-json-viewer.js') }}"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8" x-data="companyScreening()">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-blue-400">TPRM Company Screening</h1>
                <div class="flex space-x-4">
                    <a href="/" class="text-blue-400 hover:text-blue-300">Home</a>
                    <a href="/enhanced/individual_screening" class="text-blue-400 hover:text-blue-300">Individual Screening</a>
                    <a href="/enhanced/dart_registry" class="text-blue-400 hover:text-blue-300">DART Registry</a>
                </div>
            </div>
            <p class="text-gray-400 mt-2">Screen companies for third-party risk management</p>
            <div class="mt-4 flex flex-wrap gap-2" x-show="providerStatus">
                <template x-for="p in providerStatus" :key="p">
                    <span class="px-2 py-1 rounded-full text-xs bg-gray-700 text-gray-300">Provider: <span class="text-blue-300" x-text="p"></span></span>
                </template>
            </div>
        </header>

        <!-- Screening Form -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8 shadow-lg" x-show="!isLoading && !results">
            <h2 class="text-xl font-semibold mb-4 text-blue-300">Company Information</h2>
            <form @submit.prevent="startScreening" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="company" class="block text-sm font-medium text-gray-300 mb-1">Company Name *</label>
                        <input type="text" id="company" x-model="formData.company" required
                            class="w-full px-4 py-2 rounded-md bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="country" class="block text-sm font-medium text-gray-300 mb-1">Country</label>
                        <input type="text" id="country" x-model="formData.country"
                            class="w-full px-4 py-2 rounded-md bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="domain" class="block text-sm font-medium text-gray-300 mb-1">Domain</label>
                        <input type="text" id="domain" x-model="formData.domain"
                            class="w-full px-4 py-2 rounded-md bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="level" class="block text-sm font-medium text-gray-300 mb-1">Screening Level</label>
                        <select id="level" x-model="formData.level"
                            class="w-full px-4 py-2 rounded-md bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="basic">Basic</option>
                            <option value="standard" selected>Standard</option>
                            <option value="enhanced">Enhanced</option>
                        </select>
                    </div>
                </div>
                <div class="flex items-center justify-between mt-6">
                    <div class="text-xs text-gray-400">
                        Requires GOOGLE_API_KEY, GOOGLE_CSE_ID, OPENAI_API_KEY
                    </div>
                    <button type="submit"
                        class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-md font-medium transition-colors duration-200">
                        Start Screening
                    </button>
                </div>
            </form>
        </div>

        <!-- Loading State -->
        <div class="bg-gray-800 rounded-lg p-8 mb-8 shadow-lg text-center" x-show="isLoading">
            <div class="flex flex-col items-center justify-center">
                <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                <h2 class="text-xl font-semibold mb-2 text-blue-300">Screening in Progress</h2>
                <p class="text-gray-400" x-text="loadingMessage"></p>
            </div>
        </div>

        <!-- Results -->
        <div class="bg-gray-800 rounded-lg shadow-lg" x-show="results" x-cloak>
            <!-- Results Header -->
            <div class="p-6 border-b border-gray-700">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-blue-300" x-text="results.company_name"></h2>
                        <p class="text-gray-400 mt-1" x-text="results.country"></p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-400">Risk Level:</span>
                            <span class="px-3 py-1 rounded-full text-sm font-medium"
                                :class="{
                                    'bg-red-900/30 text-red-400': results.overall_risk_level === 'High',
                                    'bg-yellow-900/30 text-yellow-400': results.overall_risk_level === 'Medium',
                                    'bg-green-900/30 text-green-400': results.overall_risk_level === 'Low'
                                }"
                                x-text="results.overall_risk_level"></span>
                        </div>
                        <button @click="openRawModal()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs">View Raw JSON</button>
                    </div>
                </div>
            </div>

            <!-- Content Grid -->
            <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Main Content -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Executive Summary -->
                    <div class="bg-gray-700/30 rounded-lg p-5">
                        <h3 class="text-lg font-semibold text-blue-300 mb-3">Executive Summary</h3>
                        <p class="text-gray-300" x-text="results.executive_summary"></p>
                    </div>

                    <!-- Company Info -->
                    <div class="bg-gray-700/30 rounded-lg">
                        <div class="p-5 border-b border-gray-700">
                            <h3 class="text-lg font-semibold text-blue-300">Company Information</h3>
                        </div>
                        <div class="p-5">
                            <table class="min-w-full divide-y divide-gray-700">
                                <tbody class="divide-y divide-gray-700">
                                    <tr>
                                        <td class="px-2 py-3 text-sm font-medium text-gray-400">Industry</td>
                                        <td class="px-2 py-3 text-sm text-gray-300" x-text="results.industry || 'N/A'"></td>
                                    </tr>
                                    <tr>
                                        <td class="px-2 py-3 text-sm font-medium text-gray-400">Founded</td>
                                        <td class="px-2 py-3 text-sm text-gray-300" x-text="results.founded_year || 'N/A'"></td>
                                    </tr>
                                    <tr>
                                        <td class="px-2 py-3 text-sm font-medium text-gray-400">Headquarters</td>
                                        <td class="px-2 py-3 text-sm text-gray-300" x-text="results.headquarters || 'N/A'"></td>
                                    </tr>
                                    <tr>
                                        <td class="px-2 py-3 text-sm font-medium text-gray-400">Website</td>
                                        <td class="px-2 py-3 text-sm text-blue-300">
                                            <template x-if="results.website">
                                                <a :href="results.website" target="_blank" class="hover:underline" x-text="results.website"></a>
                                            </template>
                                            <template x-if="!results.website">
                                                <span class="text-gray-300">N/A</span>
                                            </template>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Adverse Media -->
                    <div class="bg-gray-700/30 rounded-lg">
                        <div class="p-5 border-b border-gray-700 flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-blue-300">Adverse Media</h3>
                            <span class="text-xs text-gray-400" x-text="(results.adverse_media?.length || 0) + ' items'"></span>
                        </div>
                        <div class="p-5">
                            <div x-show="results.adverse_media && results.adverse_media.length > 0">
                                <div class="space-y-4">
                                    <template x-for="media in results.adverse_media" :key="media.url || media.title">
                                        <div class="border border-gray-700 rounded p-4">
                                            <h4 class="font-medium text-gray-200 mb-1" x-text="media.title"></h4>
                                            <p class="text-xs text-gray-400 mb-2" x-text="media.date"></p>
                                            <p class="text-gray-300 text-sm" x-text="media.summary"></p>
                                            <div class="mt-2">
                                                <a :href="media.url" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm">Source</a>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <div x-show="!results.adverse_media || results.adverse_media.length === 0" class="text-gray-400">
                                No adverse media found.
                            </div>
                        </div>
                    </div>

                    <!-- Executives -->
                    <div class="bg-gray-700/30 rounded-lg">
                        <div class="p-5 border-b border-gray-700 flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-blue-300">Key Executives</h3>
                            <span class="text-xs text-gray-400" x-text="(results.executives?.length || 0) + ' listed'"></span>
                        </div>
                        <div class="p-5">
                            <div class="bg-gray-700/10 rounded-lg overflow-hidden" x-show="results.executives && results.executives.length > 0">
                                <table class="min-w-full divide-y divide-gray-700">
                                    <thead>
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Name</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Position</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Risk</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-700">
                                        <template x-for="executive in results.executives" :key="executive.name + (executive.position||'')">
                                            <tr>
                                                <td class="px-4 py-3 text-sm text-gray-300" x-text="executive.name"></td>
                                                <td class="px-4 py-3 text-sm text-gray-300" x-text="executive.position"></td>
                                                <td class="px-4 py-3">
                                                    <span class="px-2 py-1 rounded-full text-xs font-medium"
                                                        :class="{
                                                            'bg-red-900/30 text-red-400': executive.risk_level === 'High',
                                                            'bg-yellow-900/30 text-yellow-400': executive.risk_level === 'Medium',
                                                            'bg-green-900/30 text-green-400': executive.risk_level === 'Low'
                                                        }"
                                                        x-text="executive.risk_level"></span>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                            <div class="text-gray-400" x-show="!results.executives || results.executives.length === 0">
                                No executive information available.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <aside class="space-y-6">
                    <!-- KPIs -->
                    <div class="bg-gray-700/30 rounded-lg p-5">
                        <h3 class="text-sm font-semibold text-gray-300 mb-4">Key Indicators</h3>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="bg-gray-800/50 rounded p-3 text-center">
                                <div class="text-2xl font-bold" :class="{'text-red-400': (results.metrics?.sanctions||0)>0, 'text-green-400': (results.metrics?.sanctions||0)===0}" x-text="results.metrics?.sanctions || 0"></div>
                                <div class="text-xs text-gray-400 mt-1">Sanctions</div>
                            </div>
                            <div class="bg-gray-800/50 rounded p-3 text-center">
                                <div class="text-2xl font-bold" :class="{'text-red-400': (results.metrics?.adverse_media||0)>5, 'text-yellow-400': (results.metrics?.adverse_media||0)>0 && (results.metrics?.adverse_media||0)<=5, 'text-green-400': (results.metrics?.adverse_media||0)===0}" x-text="results.metrics?.adverse_media || 0"></div>
                                <div class="text-xs text-gray-400 mt-1">Adverse</div>
                            </div>
                            <div class="bg-gray-800/50 rounded p-3 text-center">
                                <div class="text-2xl font-bold text-blue-400" x-text="results.executives?.length || 0"></div>
                                <div class="text-xs text-gray-400 mt-1">Executives</div>
                            </div>
                        </div>
                    </div>

                    <!-- Providers -->
                    <div class="bg-gray-700/30 rounded-lg p-5">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-semibold text-gray-300">Providers</h3>
                            <span class="text-xs text-gray-400" x-text="results._search_timestamp ? 'at ' + formatTimestamp(results._search_timestamp) : ''"></span>
                        </div>
                        <div class="flex flex-wrap gap-2" x-show="results._providers && results._providers.length">
                            <template x-for="p in results._providers" :key="p">
                                <span class="px-2 py-1 rounded-full text-xs bg-gray-800 text-gray-300" x-text="p"></span>
                            </template>
                        </div>
                        <div class="text-xs text-gray-500" x-show="!results._providers || results._providers.length===0">No providers reported</div>
                        <div class="text-xs text-red-400 mt-3" x-show="results._errors">Error: <span x-text="results._errors"></span></div>
                    </div>

                    <!-- Actions -->
                    <div class="bg-gray-700/30 rounded-lg p-5 flex items-center justify-between">
                        <button @click="resetForm" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-md text-sm transition-colors duration-200">New Screening</button>
                        <button @click="exportRawData" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-md text-sm transition-colors duration-200">Export JSON</button>
                    </div>
                </aside>
            </div>
        </div>

        <!-- Raw JSON Modal -->
        <div x-show="rawModalOpen" x-cloak class="fixed inset-0 z-50 flex items-center justify-center">
            <div class="absolute inset-0 bg-black bg-opacity-60" @click="closeRawModal()"></div>
            <div class="relative bg-gray-900 border border-gray-700 rounded-lg w-11/12 lg:w-3/4 max-h-[85vh] overflow-hidden shadow-xl">
                <div class="flex items-center justify-between px-4 py-3 border-b border-gray-700">
                    <h3 class="text-sm font-semibold text-gray-200">Raw Screening JSON</h3>
                    <div class="flex items-center gap-2">
                        <button @click="copyRawData" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs">Copy</button>
                        <button @click="exportRawData" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs">Export</button>
                        <button @click="closeRawModal()" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs">Close</button>
                    </div>
                </div>
                <div class="p-4 overflow-auto">
                    <pre class="text-xs text-gray-300 whitespace-pre-wrap" x-text="rawJson"></pre>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-12 text-center text-gray-500 text-sm">
            <p>&copy; 2025 TPRM Tool. All rights reserved.</p>
        </footer>
    </div>

    <script>
        function companyScreening() {
            return {
                formData: {
                    company: '',
                    country: '',
                    domain: '',
                    level: 'standard'
                },
                isLoading: false,
                loadingMessage: 'Initializing screening...',
                results: null,
                activeTab: 'overview',
                providerStatus: null,
                loadingMessages: [
                    'Searching for company information...',
                    'Analyzing company structure...',
                    'Checking sanctions lists...',
                    'Scanning for adverse media...',
                    'Evaluating risk factors...',
                    'Compiling executive profiles...',
                    'Finalizing risk assessment...'
                ],
                loadingInterval: null,
                rawModalOpen: false,
                rawJson: '',
                
                startScreening() {
                    this.isLoading = true;
                    this.loadingMessage = this.loadingMessages[0];
                    let messageIndex = 1;
                    
                    // Simulate loading with changing messages
                    this.loadingInterval = setInterval(() => {
                        if (messageIndex < this.loadingMessages.length) {
                            this.loadingMessage = this.loadingMessages[messageIndex];
                            messageIndex++;
                        }
                    }, 1500);
                    
                    // Make API call
                    fetch('/api/screen', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(this.formData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        clearInterval(this.loadingInterval);
                        this.results = data;
                        this.isLoading = false;
                        this.providerStatus = data?._providers || null;
                        this.activeTab = 'overview';
                        this.rawJson = JSON.stringify(data, null, 2);
                        
                        // Initialize the enhanced JSON viewer
                        setTimeout(() => {
                            const jsonViewer = document.getElementById('json-viewer');
                            if (jsonViewer) {
                                jsonViewer.setAttribute('data-json', JSON.stringify(data));
                                new EnhancedJsonViewer({
                                    container: jsonViewer,
                                    data: data,
                                    theme: 'dark'
                                });
                            }
                        }, 100);
                    })
                    .catch(error => {
                        clearInterval(this.loadingInterval);
                        this.isLoading = false;
                        alert('Error: ' + error.message);
                    });
                },
                openRawModal() { this.rawModalOpen = true; },
                closeRawModal() { this.rawModalOpen = false; },
                
                resetForm() {
                    this.results = null;
                    this.formData = {
                        company: '',
                        country: '',
                        domain: '',
                        level: 'standard'
                    };
                },
                
                formatTimestamp(timestamp) {
                    if (!timestamp) return 'Unknown';
                    const date = new Date(timestamp);
                    return date.toLocaleString();
                },
                
                copyRawData() {
                    navigator.clipboard.writeText(JSON.stringify(this.results, null, 2))
                        .then(() => alert('Raw data copied to clipboard'))
                        .catch(err => alert('Failed to copy: ' + err));
                },
                
                exportRawData() {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.results, null, 2));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", `${this.results.company_name.replace(/\s+/g, '_')}_screening.json`);
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                }
            };
        }
    </script>
</body>
</html>
