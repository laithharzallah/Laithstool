{% extends "_base.html" %}

{% block content %}
<section class="grid gap-6">
    <!-- KPI Dashboard -->
    <div class="grid md:grid-cols-4 gap-4">
        <div class="kpi-tile">
            <div class="text-sm text-[var(--text-1)]">Overall Risk</div>
            <div class="text-2xl font-bold font-mono" id="kpi-overall">—</div>
        </div>
        <div class="kpi-tile">
            <div class="text-sm text-[var(--text-1)]">Sanctions</div>
            <div class="text-xl font-mono" id="kpi-sanc">—</div>
        </div>
        <div class="kpi-tile">
            <div class="text-sm text-[var(--text-1)]">PEP</div>
            <div class="text-xl font-mono" id="kpi-pep">—</div>
        </div>
        <div class="kpi-tile">
            <div class="text-sm text-[var(--text-1)]">Adverse Media</div>
            <div class="text-xl font-mono" id="kpi-adv">—</div>
        </div>
    </div>

    <!-- Company Screening Form -->
    <div class="surface p-6">
        <div class="text-lg font-semibold mb-4">Company Screening</div>
        <form id="companyForm" class="grid md:grid-cols-2 gap-4">
            <!-- Company Information -->
            <div>
                <label class="text-sm text-[var(--text-1)]">Company Name *</label>
                <input name="companyName" class="input w-full" placeholder="e.g., Rawabi Holding" required>
            </div>
            <div>
                <label class="text-sm text-[var(--text-1)]">Country</label>
                <input name="country" class="input w-full" placeholder="e.g., Saudi Arabia">
            </div>
            <div>
                <label class="text-sm text-[var(--text-1)]">Domain</label>
                <input name="domain" class="input w-full" placeholder="e.g., rawabiholding.com">
            </div>
            <div>
                <label class="text-sm text-[var(--text-1)]">LEI / Reg ID</label>
                <input name="lei" class="input w-full" placeholder="Legal Entity Identifier">
            </div>
            
            <!-- Jurisdiction Selection -->
            <div class="md:col-span-2">
                <label class="text-sm text-[var(--text-1)] mb-2 block">Jurisdictions</label>
                <div class="flex flex-wrap gap-2 mb-2">
                    <button type="button" class="jurisdiction-chip" data-jurisdiction="US">🇺🇸 United States</button>
                    <button type="button" class="jurisdiction-chip" data-jurisdiction="EU">🇪🇺 European Union</button>
                    <button type="button" class="jurisdiction-chip" data-jurisdiction="UN">🇺🇳 United Nations</button>
                    <button type="button" class="jurisdiction-chip" data-jurisdiction="UK">🇬🇧 United Kingdom</button>
                    <button type="button" class="jurisdiction-chip" data-jurisdiction="CA">🇨🇦 Canada</button>
                    <button type="button" class="jurisdiction-chip" data-jurisdiction="GCC">🏴 Gulf Cooperation Council</button>
                </div>
                <input name="jurisdictions" class="input w-full" placeholder="Selected jurisdictions will appear here" readonly>
            </div>
            
            <!-- Fuzzy Threshold -->
            <div>
                <label class="text-sm text-[var(--text-1)]">Fuzzy Threshold (0.0–1.0)</label>
                <input name="fuzzy" type="number" min="0" max="1" step="0.05" value="0.8" class="input w-full">
                <div class="text-xs text-[var(--text-1)] mt-1">Higher values = more exact matches</div>
            </div>
            
            <!-- Action Buttons -->
            <div class="md:col-span-2 flex flex-wrap gap-3 mt-2">
                <button type="submit" class="btn">
                    <span class="mr-2">🔍</span>Run Screening
                </button>
                <button type="button" class="btn-ghost" id="btnQueue">
                    <span class="mr-2">⏳</span>Queue Job
                </button>
                <button type="button" class="btn-ghost" id="btnExport">
                    <span class="mr-2">📥</span>Export
                </button>
            </div>
        </form>
    </div>

    <!-- Results Section with Tabs -->
    <div class="surface p-6">
        <div class="border-b border-white/10 mb-4">
            <nav class="flex gap-6">
                <button type="button" id="tab-details" class="py-2 border-b-2 border-accent-blue text-accent-blue">Details</button>
                <button type="button" id="tab-overall" class="py-2 text-[var(--text-1)] hover:text-white/90">Overall Results</button>
            </nav>
        </div>

        <!-- Details Panel (existing renderer) -->
        <div id="panel-details">
            {% include "partials/_results.html" %}
        </div>

        <!-- Overall Results Panel (aggregated raw response) -->
        <div id="panel-overall" class="hidden">
            <div class="text-sm text-[var(--text-1)] mb-2">Complete API Response</div>
            <pre id="overall-json" class="bg-[var(--bg-2)] p-4 rounded-xl overflow-auto text-sm leading-relaxed">—</pre>
        </div>
    </div>
</section>

<script>
// Jurisdiction chip selection
document.querySelectorAll('.jurisdiction-chip').forEach(chip => {
    chip.addEventListener('click', function() {
        this.classList.toggle('selected');
        updateJurisdictions();
    });
});

function updateJurisdictions() {
    const selected = Array.from(document.querySelectorAll('.jurisdiction-chip.selected'))
        .map(chip => chip.textContent.trim());
    document.querySelector('input[name="jurisdictions"]').value = selected.join(', ');
}

// Form submission
const form = document.getElementById('companyForm');
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const payload = Object.fromEntries(new FormData(form).entries());
    payload.jurisdictions = (payload.jurisdictions || '').split(',').map(s => s.trim()).filter(Boolean);
    payload.fuzzy = parseFloat(payload.fuzzy || '0.8');
    
    showSkeleton(true);
    
    try {
        // Build API payload to match backend expectations
        const apiBody = {
            company_name: payload.companyName,
            country: (payload.country || '').trim(),
            domain: (payload.domain || '').trim(),
            screening_level: 'advanced'
        };

        const res = await fetch('/api/enhanced-screen', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify(apiBody)
        });
        
        const data = await res.json();
        
        if (!res.ok) {
            toast('Error: ' + (data.error || 'request failed'), 'error');
            return;
        }
        
        // Adapt backend response to UI renderer expectations
        const sancHits = Number(((data.dilisense || {}).sanctions || {}).total_hits || 0);
        const pepHits  = Number(((data.dilisense || {}).pep || {}).total_hits || 0);
        // Prefer Dilisense adverse count; fallback to web adverse items count
        const webCat = (((data.web_search || {}).categorized_results) || {});
        const webAdvCount = Array.isArray(webCat.adverse_media) ? webCat.adverse_media.length : 0;
        const webExecCount = Array.isArray(webCat.executives) ? webCat.executives.length : 0;
        const advHits  = Number(((data.dilisense || {}).adverse_media || {}).total_hits || 0) || webAdvCount;
        const riskScore = Number(data.risk_score || 0);

        const adapted = {
            metrics: {
                overall_risk: Math.max(0, Math.min(1, riskScore / 100)),
                sanctions: sancHits > 0 ? 1 : 0,
                pep: pepHits > 0 ? 1 : 0,
                adverse_media: advHits > 0 ? 1 : 0,
                // Include web findings to avoid all-zero KPIs when compliance data is empty
                matches: (sancHits + pepHits + advHits + webExecCount + webAdvCount),
                alerts: sancHits + pepHits,
            },
            entity: { country: data.country || '' },
            ts: data.timestamp || new Date().toISOString(),
            ai_summary: { commentary: 'Screening completed.' },
            providers: { openai: true, dilisense: true },
        };

        // Save full response and show in Overall tab
        try {
            window.__last_api__ = data;
            const overallEl = document.getElementById('overall-json');
            if (overallEl) overallEl.textContent = JSON.stringify(data, null, 2);
            showPanel('overall');
        } catch (_) {}

        renderCompanyResults(adapted);
        toast('Screening completed successfully', 'success');
        
    } catch (error) {
        toast('Network error: ' + error.message, 'error');
    } finally {
        showSkeleton(false);
    }
});

// Button handlers
document.getElementById('btnQueue').addEventListener('click', () => {
    toast('Queued for processing (demo)', 'info');
});

document.getElementById('btnExport').addEventListener('click', exportReport);

// Simple tabs for Details / Overall Results
function initTabs() {
    const tabDetails = document.getElementById('tab-details');
    const tabOverall = document.getElementById('tab-overall');
    const panelDetails = document.getElementById('panel-details');
    const panelOverall = document.getElementById('panel-overall');

    if (!tabDetails || !tabOverall || !panelDetails || !panelOverall) return;

    function showPanel(which) {
        const isOverall = which === 'overall';
        panelOverall.classList.toggle('hidden', !isOverall);
        panelDetails.classList.toggle('hidden', isOverall);
        // styling
        if (isOverall) {
            tabOverall.classList.add('border-b-2','border-accent-blue','text-accent-blue');
            tabOverall.classList.remove('text-[var(--text-1)]');
            tabDetails.classList.remove('border-b-2','border-accent-blue','text-accent-blue');
            tabDetails.classList.add('text-[var(--text-1)]');
        } else {
            tabDetails.classList.add('border-b-2','border-accent-blue','text-accent-blue');
            tabDetails.classList.remove('text-[var(--text-1)]');
            tabOverall.classList.remove('border-b-2','border-accent-blue','text-accent-blue');
            tabOverall.classList.add('text-[var(--text-1)]');
        }
    }

    tabDetails.addEventListener('click', (e) => { e.preventDefault(); showPanel('details'); });
    tabOverall.addEventListener('click', (e) => { e.preventDefault(); showPanel('overall'); });

    // expose for use after API
    window.__showPanel = showPanel;
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTabs);
} else {
    initTabs();
}
</script>
{% endblock %}
