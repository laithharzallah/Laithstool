{% extends "_base.html" %}

{% block content %}
<section class="grid gap-6">
    <!-- KPI Dashboard -->
    <div class="grid md:grid-cols-4 gap-4">
        <div class="kpi-tile">
            <div class="text-sm text-[var(--text-1)]">Overall Risk</div>
            <div class="text-2xl font-bold font-mono" id="kpi-overall">‚Äî</div>
        </div>
        <div class="kpi-tile">
            <div class="text-sm text-[var(--text-1)]">Sanctions</div>
            <div class="text-xl font-mono" id="kpi-sanc">‚Äî</div>
        </div>
        <div class="kpi-tile">
            <div class="text-sm text-[var(--text-1)]">PEP</div>
            <div class="text-xl font-mono" id="kpi-pep">‚Äî</div>
        </div>
        <div class="kpi-tile">
            <div class="text-sm text-[var(--text-1)]">Adverse Media</div>
            <div class="text-xl font-mono" id="kpi-adv">‚Äî</div>
        </div>
    </div>

    <!-- Company Screening Form -->
    <div class="surface p-6">
        <div class="text-lg font-semibold mb-4">Company Screening</div>
        <form id="companyForm" class="grid md:grid-cols-2 gap-4">
            <!-- Company Information -->
            <div>
                <label class="text-sm text-[var(--text-1)]">Company Name *</label>
                <input name="companyName" class="input w-full" placeholder="e.g., Rawabi Holding" required>
            </div>
            <div>
                <label class="text-sm text-[var(--text-1)]">Country</label>
                <input name="country" class="input w-full" placeholder="e.g., Saudi Arabia">
            </div>
            <div>
                <label class="text-sm text-[var(--text-1)]">Domain</label>
                <input name="domain" class="input w-full" placeholder="e.g., rawabiholding.com">
            </div>
            <div>
                <label class="text-sm text-[var(--text-1)]">LEI / Reg ID</label>
                <input name="lei" class="input w-full" placeholder="Legal Entity Identifier">
            </div>
            
            <!-- Action Buttons -->
            <div class="md:col-span-2 flex flex-wrap gap-3 mt-2">
                <button type="submit" class="btn">
                    <span class="mr-2">üîç</span>Run Screening
                </button>
                <button type="button" class="btn-ghost" id="btnQueue">
                    <span class="mr-2">‚è≥</span>Queue Job
                </button>
                <button type="button" class="btn-ghost" id="btnExport">
                    <span class="mr-2">üì•</span>Export
                </button>
            </div>
        </form>
    </div>

    <!-- Results Section with Simple Tabs -->
    <div class="surface p-6" id="resultsContainer" style="display: none;">
        <!-- Tab Navigation -->
        <div class="border-b border-white/10 mb-6">
            <nav class="flex gap-6">
                <button type="button" class="tab-btn active" data-tab="summary">
                    üìä Summary
                </button>
                <button type="button" class="tab-btn" data-tab="details">
                    üîç Details  
                </button>
                <button type="button" class="tab-btn" data-tab="raw">
                    üìÑ Raw JSON
                </button>
            </nav>
        </div>

        <!-- Summary Tab -->
        <div class="tab-content" id="tab-summary">
            <div class="grid gap-6">
                <!-- Quick Stats -->
                <div class="grid md:grid-cols-3 gap-4">
                    <div class="surface p-4">
                        <div class="text-sm text-[var(--text-1)] mb-2">Company Info</div>
                        <div id="summary-company" class="text-[var(--text-0)]">‚Äî</div>
                    </div>
                    <div class="surface p-4">
                        <div class="text-sm text-[var(--text-1)] mb-2">Executives Found</div>
                        <div id="summary-executives" class="text-[var(--text-0)]">‚Äî</div>
                    </div>
                    <div class="surface p-4">
                        <div class="text-sm text-[var(--text-1)] mb-2">Risk Assessment</div>
                        <div id="summary-risk" class="text-[var(--text-0)]">‚Äî</div>
                    </div>
                </div>
                
                <!-- Findings -->
                <div class="surface p-4">
                    <div class="text-sm text-[var(--text-1)] mb-2">Key Findings</div>
                    <div id="summary-findings" class="text-[var(--text-0)]">‚Äî</div>
                </div>
            </div>
        </div>

        <!-- Details Tab -->
        <div class="tab-content hidden" id="tab-details">
            <div class="grid gap-6">
                <div class="surface p-4">
                    <div class="text-sm text-[var(--text-1)] mb-2">Dilisense Results</div>
                    <div id="details-dilisense" class="text-[var(--text-0)] text-sm">‚Äî</div>
                </div>
                <div class="surface p-4">
                    <div class="text-sm text-[var(--text-1)] mb-2">Web Search Results</div>
                    <div id="details-web" class="text-[var(--text-0)] text-sm">‚Äî</div>
                </div>
            </div>
        </div>

        <!-- Raw JSON Tab -->
        <div class="tab-content hidden" id="tab-raw">
            <div class="surface p-4">
                <div class="text-sm text-[var(--text-1)] mb-2">Complete API Response</div>
                <pre id="raw-json" class="bg-[var(--bg-2)] p-4 rounded-xl overflow-auto text-xs leading-relaxed" style="max-height: 600px;">‚Äî</pre>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="surface p-6 text-center" style="display: none;">
        <div class="text-lg">üîç Screening in progress...</div>
        <div class="text-sm text-[var(--text-1)] mt-2">This may take up to 60 seconds</div>
    </div>
</section>

<style>
.tab-btn {
    padding: 12px 16px;
    border-bottom: 2px solid transparent;
    color: var(--text-1);
    transition: all 0.2s ease;
    cursor: pointer;
    background: none;
    border-top: none;
    border-left: none;
    border-right: none;
}
.tab-btn:hover {
    color: var(--text-0);
}
.tab-btn.active {
    color: #3b82f6;
    border-bottom-color: #3b82f6;
}
</style>

<script>
// Simple tab system
function initTabs() {
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const targetTab = btn.getAttribute('data-tab');
            
            // Update button states
            tabBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // Update content visibility
            tabContents.forEach(content => {
                if (content.id === `tab-${targetTab}`) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });
        });
    });
}

// Form submission
const form = document.getElementById('companyForm');
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const payload = Object.fromEntries(new FormData(form).entries());
    
    // Show loading
    document.getElementById('resultsContainer').style.display = 'none';
    document.getElementById('loadingState').style.display = 'block';
    
    try {
        // Login first
        await fetch('/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'username=admin&password=change-me',
            credentials: 'include'
        });
        
        // Build API payload
        const apiBody = {
            company_name: payload.companyName,
            country: (payload.country || '').trim(),
            domain: (payload.domain || '').trim(),
            screening_level: 'advanced'
        };

        const res = await fetch('/api/enhanced-screen', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify(apiBody)
        });
        
        const data = await res.json();
        
        if (!res.ok) {
            alert('Error: ' + (data.error || 'request failed'));
            return;
        }
        
        // Show results and populate
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('resultsContainer').style.display = 'block';
        
        // Populate all tabs
        populateResults(data);
        
        // Auto-switch to Raw JSON tab to show data
        document.querySelector('.tab-btn[data-tab="raw"]').click();
        
    } catch (error) {
        alert('Network error: ' + error.message);
    } finally {
        document.getElementById('loadingState').style.display = 'none';
    }
});

function populateResults(data) {
    try {
        // Raw JSON tab
        document.getElementById('raw-json').textContent = JSON.stringify(data, null, 2);
        
        // Summary tab
        const ws = data.web_search || {};
        const cat = ws.categorized_results || {};
        const ci = cat.company_info || {};
        const execs = cat.executives || [];
        const adverse = cat.adverse_media || [];
        
        document.getElementById('summary-company').innerHTML = `
            <div><strong>Name:</strong> ${data.company || '‚Äî'}</div>
            <div><strong>Website:</strong> ${ci.website ? `<a href="${ci.website}" target="_blank">${ci.website}</a>` : '‚Äî'}</div>
            <div><strong>Industry:</strong> ${ci.industry || '‚Äî'}</div>
        `;
        
        document.getElementById('summary-executives').innerHTML = `
            <div><strong>Count:</strong> ${execs.length}</div>
            ${execs.slice(0, 3).map(e => `<div>‚Ä¢ ${e.name || 'Unknown'} (${e.position || 'Unknown'})</div>`).join('')}
        `;
        
        document.getElementById('summary-risk').innerHTML = `
            <div><strong>Score:</strong> ${data.risk_score || 0}</div>
            <div><strong>Level:</strong> ${data.overall_risk_level || 'Low'}</div>
            <div><strong>Adverse Items:</strong> ${adverse.length}</div>
        `;
        
        document.getElementById('summary-findings').innerHTML = `
            <div><strong>Providers:</strong> ${(ws.providers_used || []).join(', ')}</div>
            <div><strong>Total Results:</strong> ${ws.total_results || 0}</div>
            <div><strong>Timestamp:</strong> ${data.timestamp || '‚Äî'}</div>
        `;
        
        // Details tab
        document.getElementById('details-dilisense').innerHTML = `
            <div><strong>Sanctions:</strong> ${(data.dilisense?.sanctions?.total_hits || 0)} hits</div>
            <div><strong>PEP:</strong> ${(data.dilisense?.pep?.total_hits || 0)} hits</div>
            <div><strong>Criminal:</strong> ${(data.dilisense?.criminal?.total_hits || 0)} hits</div>
        `;
        
        document.getElementById('details-web').innerHTML = `
            <div><strong>Company Info:</strong> ${Object.keys(ci).length} fields</div>
            <div><strong>Executives:</strong> ${execs.length} found</div>
            <div><strong>Adverse Media:</strong> ${adverse.length} items</div>
        `;
        
        // Update top KPIs
        const dilisense = data.dilisense || {};
        const sancHits = (dilisense.sanctions?.total_hits || 0);
        const pepHits = (dilisense.pep?.total_hits || 0);
        const crimHits = (dilisense.criminal?.total_hits || 0);
        
        document.getElementById('kpi-overall').textContent = data.overall_risk_level || 'Low';
        document.getElementById('kpi-sanc').textContent = sancHits;
        document.getElementById('kpi-pep').textContent = pepHits;
        document.getElementById('kpi-adv').textContent = adverse.length;
        
    } catch (error) {
        console.error('Error populating results:', error);
        document.getElementById('raw-json').textContent = 'Error: ' + error.message;
    }
}

// Initialize tabs when page loads
document.addEventListener('DOMContentLoaded', initTabs);

// Button handlers
document.getElementById('btnQueue').addEventListener('click', () => {
    alert('Queued for processing (demo)');
});

document.getElementById('btnExport').addEventListener('click', () => {
    const data = document.getElementById('raw-json').textContent;
    if (data && data !== '‚Äî') {
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `company_screening_${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
});
</script>
{% endblock %}