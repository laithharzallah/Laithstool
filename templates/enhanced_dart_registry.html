<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPRM - DART Registry</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/enhanced-json-viewer.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.10.3/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.3.3/dist/echarts.min.js"></script>
    <script src="{{ url_for('static', filename='js/enhanced-json-viewer.js') }}"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8" x-data="dartRegistry()">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-green-400">DART Registry Lookup</h1>
                <div class="flex space-x-4">
                    <a href="/" class="text-green-400 hover:text-green-300">Home</a>
                    <a href="/enhanced/company_screening" class="text-green-400 hover:text-green-300">Company Screening</a>
                    <a href="/enhanced/individual_screening" class="text-green-400 hover:text-green-300">Individual Screening</a>
                </div>
            </div>
            <p class="text-gray-400 mt-2">Search Korean companies in the official Financial Supervisory Service registry</p>
            <div class="mt-4 flex flex-wrap gap-2" x-show="results && !error">
                <button @click="copy(results.company_name)" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs" aria-label="Copy Company Name">Copy Name</button>
                <button @click="copy(results.registry_id)" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs" aria-label="Copy Registry ID">Copy Registry ID</button>
                <button x-show="results.website" @click="openSite(results.website)" class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-xs" aria-label="Open Website">Open Website</button>
                <button @click="resetForm" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs" aria-label="New Search">New Search</button>
            </div>
        </header>

        <!-- Search Form -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8 shadow-lg" x-show="!isLoading && !results">
            <h2 class="text-xl font-semibold mb-4 text-green-300">DART-Only Search</h2>
            <div class="bg-gray-700/30 rounded-lg p-4 mb-6 flex items-start">
                <div class="text-blue-400 mr-3 mt-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                </div>
                <p class="text-gray-300 text-sm">
                    This search uses only the official DART registry from the Korean Financial Supervisory Service.
                </p>
            </div>
            <form @submit.prevent="startLookup" class="space-y-4">
                <div>
                    <label for="company" class="block text-sm font-medium text-gray-300 mb-1">Company Name *</label>
                    <input type="text" id="company" x-model="formData.company" required
                        class="w-full px-4 py-2 rounded-md bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                    <label for="registry_id" class="block text-sm font-medium text-gray-300 mb-1">Registry ID (optional)</label>
                    <input type="text" id="registry_id" x-model="formData.registry_id"
                        class="w-full px-4 py-2 rounded-md bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div class="flex justify-end mt-6">
                    <button type="submit"
                        class="px-6 py-2 bg-green-600 hover:bg-green-700 rounded-md font-medium transition-colors duration-200">
                        Search Registry
                    </button>
                </div>
            </form>
        </div>

        <!-- Loading State -->
        <div class="bg-gray-800 rounded-lg p-8 mb-8 shadow-lg text-center" x-show="isLoading">
            <div class="flex flex-col items-center justify-center">
                <div class="w-16 h-16 border-4 border-green-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                <h2 class="text-xl font-semibold mb-2 text-green-300">Searching Registry</h2>
                <p class="text-gray-400" x-text="loadingMessage"></p>
            </div>
        </div>

        <!-- Error State -->
        <div class="bg-gray-800 rounded-lg p-8 mb-8 shadow-lg" x-show="error" x-cloak>
            <div class="flex items-center justify-center">
                <div class="w-16 h-16 rounded-full bg-red-900/30 flex items-center justify-center mr-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <div>
                    <h2 class="text-xl font-semibold mb-2 text-red-400">Search Error</h2>
                    <p class="text-gray-300">Search failed. Please try again.</p>
                    <button @click="resetForm" class="mt-4 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-md text-sm transition-colors duration-200">
                        Try Again
                    </button>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="bg-gray-800 rounded-lg shadow-lg" x-show="results && !error" x-cloak>
            <!-- Results Header -->
            <div class="p-6 border-b border-gray-700">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-green-300" x-text="results.company_name"></h2>
                        <div class="flex items-center mt-1">
                            <span class="text-gray-400 mr-2">Registry ID:</span>
                            <span class="px-3 py-1 bg-gray-700 rounded-full text-sm font-medium text-green-300" x-text="results.registry_id"></span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-400">Status:</span>
                        <span class="px-3 py-1 rounded-full text-sm font-medium bg-green-900/30 text-green-400" x-text="results.status"></span>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="border-b border-gray-700">
                <nav class="flex overflow-x-auto" aria-label="Tabs">
                    <button @click="activeTab = 'overview'" 
                        class="px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 transition-colors duration-200"
                        :class="activeTab === 'overview' ? 'border-green-500 text-green-400' : 'border-transparent text-gray-400 hover:text-gray-300'">
                        Overview <span class="ml-2 text-xs text-gray-400" x-text="coverageFor('overview').label"></span>
                    </button>
                    <button @click="activeTab = 'executives'" 
                        class="px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 transition-colors duration-200"
                        :class="activeTab === 'executives' ? 'border-green-500 text-green-400' : 'border-transparent text-gray-400 hover:text-gray-300'">
                        Executives/Board <span class="ml-2 text-xs text-gray-400" x-text="coverageFor('executives').label"></span>
                    </button>
                    <button @click="activeTab = 'shareholders'" 
                        class="px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 transition-colors duration-200"
                        :class="activeTab === 'shareholders' ? 'border-green-500 text-green-400' : 'border-transparent text-gray-400 hover:text-gray-300'">
                        Shareholders <span class="ml-2 text-xs text-gray-400" x-text="coverageFor('shareholders').label"></span>
                    </button>
                    <button @click="activeTab = 'financial'" 
                        class="px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 transition-colors duration-200"
                        :class="activeTab === 'financial' ? 'border-green-500 text-green-400' : 'border-transparent text-gray-400 hover:text-gray-300'">
                        Financials <span class="ml-2 text-xs text-gray-400" x-text="coverageFor('financial').label"></span>
                    </button>
                    <button @click="activeTab = 'documents'" 
                        class="px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 transition-colors duration-200"
                        :class="activeTab === 'documents' ? 'border-green-500 text-green-400' : 'border-transparent text-gray-400 hover:text-gray-300'">
                        Filings <span class="ml-2 text-xs text-gray-400" x-text="coverageFor('filings').label"></span>
                    </button>
                    <button @click="activeTab = 'adverse'" 
                        class="px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 transition-colors duration-200"
                        :class="activeTab === 'adverse' ? 'border-green-500 text-green-400' : 'border-transparent text-gray-400 hover:text-gray-300'">
                        Adverse Media <span class="ml-2 text-xs text-gray-400" x-text="coverageFor('adverse').label"></span>
                    </button>
                    <button @click="activeTab = 'compliance'" 
                        class="px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 transition-colors duration-200"
                        :class="activeTab === 'compliance' ? 'border-green-500 text-green-400' : 'border-transparent text-gray-400 hover:text-gray-300'">
                        Sanctions & PEP <span class="ml-2 text-xs text-gray-400" x-text="coverageFor('compliance').label"></span>
                    </button>
                    <button @click="activeTab = 'identifiers'" 
                        class="px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 transition-colors duration-200"
                        :class="activeTab === 'identifiers' ? 'border-green-500 text-green-400' : 'border-transparent text-gray-400 hover:text-gray-300'">
                        Identifiers <span class="ml-2 text-xs text-gray-400" x-text="coverageFor('identifiers').label"></span>
                    </button>
                    <button @click="activeTab = 'structure'" 
                        class="px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 transition-colors duration-200"
                        :class="activeTab === 'structure' ? 'border-green-500 text-green-400' : 'border-transparent text-gray-400 hover:text-gray-300'">
                        Corporate Structure
                    </button>
                    <button @click="activeTab = 'raw'" 
                        class="px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 transition-colors duration-200"
                        :class="activeTab === 'raw' ? 'border-green-500 text-green-400' : 'border-transparent text-gray-400 hover:text-gray-300'">
                        Raw Data
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                <!-- Overview Tab -->
                <div x-show="activeTab === 'overview'">
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-green-300 mb-3">Company Information</h3>
                        <div class="bg-gray-700/30 rounded-lg overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-700">
                                <tbody class="divide-y divide-gray-700">
                                    <tr>
                                        <td class="px-4 py-3 text-sm font-medium text-gray-400">Registration Date</td>
                                        <td class="px-4 py-3 text-sm text-gray-300" x-text="results.registration_date"></td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-3 text-sm font-medium text-gray-400">Industry</td>
                                        <td class="px-4 py-3 text-sm text-gray-300" x-text="results.industry_name + ' (' + results.industry_code + ')'"></td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-3 text-sm font-medium text-gray-400">Address</td>
                                        <td class="px-4 py-3 text-sm text-gray-300" x-text="results.address"></td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-3 text-sm font-medium text-gray-400">Representative</td>
                                        <td class="px-4 py-3 text-sm text-gray-300" x-text="results.representative"></td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-3 text-sm font-medium text-gray-400">Capital</td>
                                        <td class="px-4 py-3 text-sm text-gray-300" x-text="results.capital"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="mb-8" x-show="results.major_shareholders && results.major_shareholders.length > 0">
                        <h3 class="text-lg font-semibold text-green-300 mb-3">Major Shareholders</h3>
                        <div class="bg-gray-700/30 rounded-lg overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead>
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Name</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Ownership</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Relationship</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-700">
                                    <template x-for="shareholder in results.major_shareholders" :key="shareholder.name">
                                        <tr>
                                            <td class="px-4 py-3 text-sm text-gray-300" x-text="shareholder.name"></td>
                                            <td class="px-4 py-3 text-sm text-gray-300" x-text="shareholder.ownership"></td>
                                            <td class="px-4 py-3 text-sm text-gray-300" x-text="shareholder.relationship"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div x-show="results.subsidiaries && results.subsidiaries.length > 0">
                        <h3 class="text-lg font-semibold text-green-300 mb-3">Subsidiaries</h3>
                        <div class="bg-gray-700/30 rounded-lg overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead>
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Name</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Ownership</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Business</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-700">
                                    <template x-for="subsidiary in results.subsidiaries" :key="subsidiary.name">
                                        <tr>
                                            <td class="px-4 py-3 text-sm text-gray-300" x-text="subsidiary.name"></td>
                                            <td class="px-4 py-3 text-sm text-gray-300" x-text="subsidiary.ownership"></td>
                                            <td class="px-4 py-3 text-sm text-gray-300" x-text="subsidiary.business"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Financial Summary Tab -->
                <div x-show="activeTab === 'financial'">
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-green-300 mb-3">Financial Summary</h3>
                        <div class="bg-gray-700/30 rounded-lg overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead>
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Metric</th>
                                        <template x-for="(value, year) in results.financial_summary.revenue" :key="year">
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider" x-text="year"></th>
                                        </template>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-700">
                                    <tr>
                                        <td class="px-4 py-3 text-sm font-medium text-gray-300">Revenue</td>
                                        <template x-for="(value, year) in results.financial_summary.revenue" :key="year">
                                            <td class="px-4 py-3 text-sm text-gray-300 text-right" x-text="formatCurrency(value, results.financial_summary.currency)"></td>
                                        </template>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-3 text-sm font-medium text-gray-300">Profit</td>
                                        <template x-for="(value, year) in results.financial_summary.profit" :key="year">
                                            <td class="px-4 py-3 text-sm text-gray-300 text-right" x-text="formatCurrency(value, results.financial_summary.currency)"></td>
                                        </template>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-3 text-sm font-medium text-gray-300">Assets</td>
                                        <template x-for="(value, year) in results.financial_summary.assets" :key="year">
                                            <td class="px-4 py-3 text-sm text-gray-300 text-right" x-text="formatCurrency(value, results.financial_summary.currency)"></td>
                                        </template>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold text-green-300 mb-3">Financial Trends</h3>
                        <div class="bg-gray-700/30 rounded-lg p-4">
                            <div id="financial-chart" class="w-full h-80"></div>
                        </div>
                    </div>
                </div>

                <!-- Filings / Documents Tab -->
                <div x-show="activeTab === 'documents'">
                    <div class="mb-2 flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-green-300">Filings / Documents</h3>
                        <input type="text" placeholder="Filter by title..." class="px-3 py-1 rounded bg-gray-700 border border-gray-600 text-sm" x-model="filingsFilter">
                    </div>
                    <div class="bg-gray-700/30 rounded-lg overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="sticky top-0 bg-gray-800/80 backdrop-blur">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Type</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">ID</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Title</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer" @click="toggleSort('date')">Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-700">
                                <template x-for="doc in pagedFilings" :key="(doc.id||doc.type||doc.title)+ (doc.date||'')">
                                    <tr class="hover:bg-gray-700/20">
                                        <td class="px-4 py-3 text-sm text-gray-300" x-text="doc.type || 'Document'"></td>
                                        <td class="px-4 py-3 text-sm text-gray-300" x-text="doc.id || '—'"></td>
                                        <td class="px-4 py-3 text-sm text-gray-300 truncate" :title="doc.title" x-text="doc.title"></td>
                                        <td class="px-4 py-3 text-sm text-gray-300" x-text="formatDate(doc.date)"></td>
                                        <td class="px-4 py-3 text-sm"><a :href="doc.url" target="_blank" class="text-green-400 hover:text-green-300" aria-label="View Filing">View</a></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                        <div class="p-4 text-sm text-gray-400" x-show="!(filingsAll && filingsAll.length)">No filings available.</div>
                    </div>
                    <div class="mt-3 flex items-center justify-between" x-show="(filingsAll && filingsAll.length)">
                        <div class="text-xs text-gray-400">Page <span x-text="filingsPage"></span> / <span x-text="filingsTotalPages"></span></div>
                        <div class="flex gap-2">
                            <button @click="prevFilings()" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs" aria-label="Prev Page">Prev</button>
                            <button @click="nextFilings()" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs" aria-label="Next Page">Next</button>
                        </div>
                    </div>
                </div>

                <!-- Corporate Structure Tab -->
                <div x-show="activeTab === 'structure'">
                    <div class="mb-8" x-show="results.major_shareholders && results.major_shareholders.length > 0">
                        <h3 class="text-lg font-semibold text-green-300 mb-3">Ownership Structure</h3>
                        <div class="bg-gray-700/30 rounded-lg p-4">
                            <div id="ownership-chart" class="w-full h-80"></div>
                        </div>
                    </div>

                    <div x-show="results.subsidiaries && results.subsidiaries.length > 0">
                        <h3 class="text-lg font-semibold text-green-300 mb-3">Corporate Hierarchy</h3>
                        <div class="bg-gray-700/30 rounded-lg p-4">
                            <div id="hierarchy-chart" class="w-full h-80"></div>
                        </div>
                    </div>
                </div>

                <!-- Raw Data Tab -->
                <div x-show="activeTab === 'raw'">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-green-300">Raw Data</h3>
                        <div class="flex space-x-2">
                            <button @click="copyRawData" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm">
                                Copy
                            </button>
                            <button @click="exportRawData" class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-sm">
                                Export
                            </button>
                        </div>
                    </div>
                    
                    <!-- Enhanced JSON Viewer -->
                    <div id="json-viewer" class="json-viewer" data-theme="dark"></div>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-6 border-t border-gray-700 flex justify-between items-center">
                <div class="text-sm text-gray-400">
                    Data retrieved at <span x-text="formatTimestamp(results.timestamp)"></span>
                </div>
                <button @click="resetForm" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-md text-sm transition-colors duration-200">
                    New Search
                </button>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-12 text-center text-gray-500 text-sm">
            <p>&copy; 2025 TPRM Tool. All rights reserved.</p>
        </footer>
    </div>

    <script>
        function dartRegistry() {
            return {
                formData: {
                    company: '',
                    registry_id: '',
                    country: 'Korea'
                },
                isLoading: false,
                loadingMessage: 'Searching DART registry...',
                results: null,
                error: false,
                activeTab: 'overview',
                loadingMessages: [
                    'Searching DART registry...',
                    'Retrieving company information...',
                    'Fetching financial data...',
                    'Loading document history...',
                    'Analyzing corporate structure...'
                ],
                loadingInterval: null,
                // Filings helpers
                filingsAll: [],
                filingsFilter: '',
                filingsSortKey: 'date',
                filingsSortDir: 'desc',
                filingsPage: 1,
                filingsPageSize: 10,
                
                startLookup() {
                    this.isLoading = true;
                    this.error = false;
                    this.loadingMessage = this.loadingMessages[0];
                    let messageIndex = 1;
                    
                    // Simulate loading with changing messages
                    this.loadingInterval = setInterval(() => {
                        if (messageIndex < this.loadingMessages.length) {
                            this.loadingMessage = this.loadingMessages[messageIndex];
                            messageIndex++;
                        }
                    }, 1500);
                    
                    // Make API call (live DART) with robust JSON handling
                    fetch('/api/dart_lookup', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(this.formData)
                    })
                    .then(async (response) => {
                        const text = await response.text();
                        let data = {};
                        try {
                            data = text ? JSON.parse(text) : {};
                        } catch (e) {
                            throw new Error(`Bad JSON (HTTP ${response.status})`);
                        }
                        if (!response.ok) {
                            const msg = (data && (data.details || data.error)) || `HTTP ${response.status}`;
                            throw new Error(msg);
                        }
                        return data;
                    })
                    .then(data => {
                        clearInterval(this.loadingInterval);
                        
                        this.results = data;
                        this.error = false;
                        // Prepare filings from either results.filings or results.documents
                        const docs = (this.results && (this.results.filings || this.results.documents)) || [];
                        this.filingsAll = Array.isArray(docs) ? docs.slice() : [];
                        this.filingsPage = 1;
                        
                        // Add timestamp if not present
                        if (!this.results.timestamp) {
                            this.results.timestamp = new Date().toISOString();
                        }
                        
                        // Initialize the enhanced JSON viewer
                        setTimeout(() => {
                            const jsonViewer = document.getElementById('json-viewer');
                            if (jsonViewer) {
                                jsonViewer.setAttribute('data-json', JSON.stringify(data));
                                new EnhancedJsonViewer({
                                    container: jsonViewer,
                                    data: data,
                                    theme: 'dark'
                                });
                            }
                            
                            this.initCharts();
                        }, 100);
                        
                        this.isLoading = false;
                        this.activeTab = 'overview';
                    })
                    .catch(error => {
                        clearInterval(this.loadingInterval);
                        this.isLoading = false;
                        this.error = true;
                        try { console.error('DART search error:', error); } catch(e) {}
                    });
                },
                // Coverage helpers
                coverageFor(tab) {
                    const scope = this._scopeFor(tab);
                    const known = this._knownKeysFor(tab);
                    const keys = scope && typeof scope==='object' ? Object.keys(scope) : [];
                    const covered = keys.filter(k => known.includes(k)).length;
                    const pct = keys.length ? Math.round((covered/keys.length)*100) : 100;
                    return { label: `Coverage: ${pct}%`, labelDetail: `${covered}/${keys.length} fields` };
                },
                getUncoveredFor(scopeObj, knownKeys) {
                    if (!scopeObj || typeof scopeObj !== 'object') return { uncoveredKeys: [], uncoveredEntries: [] };
                    const keys = Object.keys(scopeObj).filter(k => !knownKeys.includes(k));
                    const entries = keys.map(k => ({ key: k, pretty: JSON.stringify(scopeObj[k], null, 2) }));
                    return { uncoveredKeys: keys, uncoveredEntries: entries };
                },
                _scopeFor(tab) {
                    if (!this.results) return {};
                    if (tab==='overview') return this.results;
                    if (tab==='executives') return { executives: this.results.executives };
                    if (tab==='shareholders') return { major_shareholders: this.results.major_shareholders };
                    if (tab==='financial') return this.results.financial_summary || {};
                    if (tab==='filings' || tab==='documents') return { filings: this.filingsAll };
                    if (tab==='adverse') return this.results.adverse_media || {};
                    if (tab==='compliance') return { sanctions_check: this.results.sanctions_check, pep_check: this.results.pep_check };
                    if (tab==='identifiers') return { identifiers: this.results.identifiers };
                    return this.results;
                },
                _knownKeysFor(tab) {
                    if (tab==='overview') return ['company_name','registry_id','status','industry_name','industry_code','address','representative','capital','website','identifiers','timestamp'];
                    if (tab==='executives') return ['executives'];
                    if (tab==='shareholders') return ['major_shareholders'];
                    if (tab==='financial') return ['currency','revenue','profit','assets','liabilities','equity'];
                    if (tab==='filings' || tab==='documents') return ['filings','documents'];
                    if (tab==='adverse') return ['summary','items'];
                    if (tab==='compliance') return ['sanctions_check','pep_check'];
                    if (tab==='identifiers') return ['identifiers'];
                    return [];
                },
                // Utilities
                parsePercent(v) {
                    if (v==null) return '—';
                    const m = String(v).match(/(\d+(?:\.\d+)?)/);
                    return m ? `${m[1]}%` : '—';
                },
                formatDate(v) {
                    if (!v) return '';
                    const d = new Date(v);
                    return isNaN(d.getTime()) ? String(v) : d.toISOString().slice(0,10);
                },
                copy(txt) {
                    if (!txt) return; navigator.clipboard.writeText(String(txt)).catch(()=>{});
                },
                openSite(u) {
                    if (!u) return; window.open(u.startsWith('http')?u:`https://${u}`,'_blank');
                },
                // Filings paging/sort
                get pagedFilings() {
                    let arr = (this.filingsAll || []).slice();
                    if (this.filingsFilter) {
                        const q = this.filingsFilter.toLowerCase();
                        arr = arr.filter(d => (d.title||'').toLowerCase().includes(q));
                    }
                    arr.sort((a,b) => {
                        const da = new Date(a.date||0).getTime();
                        const db = new Date(b.date||0).getTime();
                        return this.filingsSortDir==='asc' ? (da-db) : (db-da);
                    });
                    const start = (this.filingsPage-1)*this.filingsPageSize;
                    return arr.slice(start, start+this.filingsPageSize);
                },
                get filingsTotalPages() {
                    const n = (this.filingsAll||[]).length;
                    return Math.max(1, Math.ceil(n/this.filingsPageSize));
                },
                nextFilings() { if (this.filingsPage < this.filingsTotalPages) this.filingsPage++; },
                prevFilings() { if (this.filingsPage > 1) this.filingsPage--; },
                toggleSort(key) { if (key==='date') this.filingsSortDir = this.filingsSortDir==='asc'?'desc':'asc'; },
                
                resetForm() {
                    this.results = null;
                    this.error = false;
                    this.formData = {
                        company: '',
                        registry_id: '',
                        country: 'Korea'
                    };
                },
                
                formatTimestamp(timestamp) {
                    if (!timestamp) return 'Unknown';
                    const date = new Date(timestamp);
                    return date.toLocaleString();
                },
                
                formatCurrency(value, currency) {
                    if (typeof value !== 'number') {
                        return value;
                    }
                    
                    // Format large numbers in millions or billions
                    if (value >= 1000000000) {
                        return `${(value / 1000000000).toFixed(2)}B ${currency}`;
                    } else if (value >= 1000000) {
                        return `${(value / 1000000).toFixed(2)}M ${currency}`;
                    } else {
                        return `${value.toLocaleString()} ${currency}`;
                    }
                },
                
                copyRawData() {
                    navigator.clipboard.writeText(JSON.stringify(this.results, null, 2))
                        .then(() => alert('Raw data copied to clipboard'))
                        .catch(err => alert('Failed to copy: ' + err));
                },
                
                exportRawData() {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.results, null, 2));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", `${this.results.company_name.replace(/\s+/g, '_')}_dart.json`);
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                },
                
                initCharts() {
                    if (!this.results) return;
                    
                    // Initialize financial chart
                    if (this.results.financial_summary) {
                        const financialChart = echarts.init(document.getElementById('financial-chart'));
                        
                        const years = Object.keys(this.results.financial_summary.revenue).sort();
                        const revenueData = years.map(year => this.results.financial_summary.revenue[year] / 1000000);
                        const profitData = years.map(year => this.results.financial_summary.profit[year] / 1000000);
                        
                        const option = {
                            backgroundColor: 'transparent',
                            tooltip: {
                                trigger: 'axis',
                                axisPointer: {
                                    type: 'shadow'
                                }
                            },
                            legend: {
                                data: ['Revenue', 'Profit'],
                                textStyle: {
                                    color: '#e2e8f0'
                                }
                            },
                            grid: {
                                left: '3%',
                                right: '4%',
                                bottom: '3%',
                                containLabel: true
                            },
                            xAxis: {
                                type: 'category',
                                data: years,
                                axisLine: {
                                    lineStyle: {
                                        color: '#4b5563'
                                    }
                                },
                                axisLabel: {
                                    color: '#e2e8f0'
                                }
                            },
                            yAxis: {
                                type: 'value',
                                name: 'Million ' + this.results.financial_summary.currency,
                                nameTextStyle: {
                                    color: '#e2e8f0'
                                },
                                axisLine: {
                                    lineStyle: {
                                        color: '#4b5563'
                                    }
                                },
                                axisLabel: {
                                    color: '#e2e8f0'
                                },
                                splitLine: {
                                    lineStyle: {
                                        color: '#374151'
                                    }
                                }
                            },
                            series: [
                                {
                                    name: 'Revenue',
                                    type: 'bar',
                                    data: revenueData,
                                    itemStyle: {
                                        color: '#10b981'
                                    }
                                },
                                {
                                    name: 'Profit',
                                    type: 'bar',
                                    data: profitData,
                                    itemStyle: {
                                        color: '#3b82f6'
                                    }
                                }
                            ]
                        };
                        
                        financialChart.setOption(option);
                        
                        // Handle resize
                        window.addEventListener('resize', () => {
                            financialChart.resize();
                        });
                    }
                    
                    // Initialize ownership chart if shareholders exist
                    if (this.results.major_shareholders && this.results.major_shareholders.length > 0) {
                        const ownershipChart = echarts.init(document.getElementById('ownership-chart'));
                        
                        const shareholders = this.results.major_shareholders.map(s => s.name);
                        const ownership = this.results.major_shareholders.map(s => {
                            // Convert percentage string to number
                            const match = s.ownership.match(/(\d+(\.\d+)?)%/);
                            return match ? parseFloat(match[1]) : 0;
                        });
                        
                        const option = {
                            backgroundColor: 'transparent',
                            tooltip: {
                                trigger: 'item',
                                formatter: '{a} <br/>{b}: {c}%'
                            },
                            legend: {
                                orient: 'vertical',
                                right: 10,
                                top: 'center',
                                data: shareholders,
                                textStyle: {
                                    color: '#e2e8f0'
                                }
                            },
                            series: [
                                {
                                    name: 'Ownership',
                                    type: 'pie',
                                    radius: ['40%', '70%'],
                                    avoidLabelOverlap: false,
                                    itemStyle: {
                                        borderRadius: 10,
                                        borderColor: '#1f2937',
                                        borderWidth: 2
                                    },
                                    label: {
                                        show: false,
                                        position: 'center'
                                    },
                                    emphasis: {
                                        label: {
                                            show: true,
                                            fontSize: '18',
                                            fontWeight: 'bold',
                                            formatter: '{b}: {c}%'
                                        }
                                    },
                                    labelLine: {
                                        show: false
                                    },
                                    data: shareholders.map((name, index) => {
                                        return {
                                            name: name,
                                            value: ownership[index]
                                        };
                                    })
                                }
                            ]
                        };
                        
                        ownershipChart.setOption(option);
                        
                        // Handle resize
                        window.addEventListener('resize', () => {
                            ownershipChart.resize();
                        });
                    }
                    
                    // Initialize hierarchy chart if subsidiaries exist
                    if (this.results.subsidiaries && this.results.subsidiaries.length > 0) {
                        const hierarchyChart = echarts.init(document.getElementById('hierarchy-chart'));
                        
                        // Create hierarchy data
                        const data = {
                            name: this.results.company_name,
                            children: this.results.subsidiaries.map(sub => {
                                return {
                                    name: sub.name,
                                    value: sub.ownership,
                                    itemStyle: {
                                        color: '#10b981'
                                    }
                                };
                            })
                        };
                        
                        const option = {
                            backgroundColor: 'transparent',
                            tooltip: {
                                trigger: 'item',
                                formatter: '{b}: {c}'
                            },
                            series: [
                                {
                                    type: 'tree',
                                    data: [data],
                                    top: '10%',
                                    left: '10%',
                                    bottom: '10%',
                                    right: '10%',
                                    symbolSize: 12,
                                    label: {
                                        position: 'left',
                                        verticalAlign: 'middle',
                                        align: 'right',
                                        color: '#e2e8f0'
                                    },
                                    leaves: {
                                        label: {
                                            position: 'right',
                                            verticalAlign: 'middle',
                                            align: 'left'
                                        }
                                    },
                                    emphasis: {
                                        focus: 'descendant'
                                    },
                                    expandAndCollapse: true,
                                    animationDuration: 550,
                                    animationDurationUpdate: 750,
                                    lineStyle: {
                                        color: '#4b5563',
                                        width: 1
                                    },
                                    itemStyle: {
                                        color: '#3b82f6'
                                    }
                                }
                            ]
                        };
                        
                        hierarchyChart.setOption(option);
                        
                        // Handle resize
                        window.addEventListener('resize', () => {
                            hierarchyChart.resize();
                        });
                    }
                }
            };
        }
    </script>
</body>
</html>
